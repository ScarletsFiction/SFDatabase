/*
  SFDatabase-js
  SFDatabase-js is a database library that can help you
  build a SQL Query and execute it to the server from
  Nodejs or local browser with WebSQL.

  https://github.com/ScarletsFiction/SFDatabase-js
*/
"use strict";function SFDatabase(e,n,r){var o=this;o.db=null,o.pending=[],o.initialized=!1,n||(n={debug:!1});var t=function(){o.initialized||(o.initialized=!0,r?setTimeout(function(){r(s)||s()},1):s())},i=-1,s=function e(){if(!o.db)return clearTimeout(i),void(i=setTimeout(e,1e3));if(o.pending.length){for(var n=0;n<o.pending.length;n++)o.pending[n]();o.pending.splice(0)}},a=function(e){if(e&&"object"==typeof e){if(e instanceof Array)e.splice(0);else for(var n=Object.keys(e),r=0;r<n.length;r++)delete e[n[r]];e=null}};o.preprocessTable={};var c=function(e,n,r){var t=!1;if(!o.preprocessTable[e])return t;for(var i=Object.keys(o.preprocessTable[e]),s=0;s<i.length;s++)r[i[s]]&&o.preprocessTable[e][i[s]][n]&&(r[i[s]]=o.preprocessTable[e][i[s]][n](r[i[s]]),t=!0);return t},u="undefined"!=typeof process&&process.execPath;if(!u)var l=null,f=function(e){var r=Object.keys(n.databaseStructure),i=r.length,s=function(){0===--i&&(e?e():t(o))};setTimeout(function(){i>1&&console.error("Failed to initialize database structure")},5e3);for(var a=0;a<r.length;a++)o.createTable(r[a],n.databaseStructure[r[a]],s);l&&(l(),l=null)};function d(){function e(e){return"`"+e.match(/[a-zA-Z0-9_\.]+/i)[0]+"`"}o.makeWhere=function(n,r,t){if(!n)return["",[]];for(var i=[],s=[],a=Object.keys(n),c=" AND ",u=["order","limit"],l=0;l<a.length;l++){var f=n[a[l]],d=a[l].match(/([a-zA-Z0-9_\.]+)(\[(\>\=?|\<\=?|\!|\<\>|\>\<|\!?~)\])?/),b=d[1].toLowerCase();if("and"!==b&&"or"!==b)if(t||-1===u.indexOf(b))if(d[3]){if(-1!==[">",">=","<","<="].indexOf(d[3])){if(!isNaN(f)){i.push(d[1]+" "+d[3]+" ?"),s.push(f);continue}var p="SQL where: value of "+d[1]+" is non-numeric and can't be accepted";console.error(p)}else if("!"===d[3]){var v;if(v=null!=f&&f.constructor.name)if("Array"===v){for(var h=[],g=0;g<f.length;g++)h.push("?");i.push(d[1]+" NOT IN ("+h.join(", ")+")"),s=s.concat(f)}else"Number"===v||"Boolean"===v||"String"===v?(i.push(d[1]+" != ?"),s.push(f)):console.error("SQL where: value "+d[1]+" with type "+v+" can't be accepted");else i.push(d[1]+" IS NOT NULL")}else if("~"===d[3]||"!~"===d[3]){f.constructor!==Array&&(f=[f]);var w=[];for(g=0;g<f.length;g++)w.push(d[1]+("!~"===d[3]?" NOT":"")+" LIKE ?"),-1===f.indexOf("%")&&(f[g]="%"+f[g]+"%"),s.push(f[g]);i.push("("+w.join(" OR ")+")")}}else if(v=null!=f&&f.constructor.name)if("Array"===v){for(h=[],g=0;g<f.length;g++)h.push("?");i.push(d[1]+" IN ("+h.join(", ")+")"),s=s.concat(f)}else"Number"===v||"Boolean"===v||"String"===v?(i.push(d[1]+" = ?"),s.push(f)):console.error("SQL where: value "+d[1]+" with type "+v+" can't be accepted");else i.push(d[1]+" IS NULL")}for(l=0;l<a.length;l++)if("ORDER"!==a[l]&&"LIMIT"!==a[l]){var I=a[l].split("AND"),T=!1;if(2===I.length&&""===I[0]?(c=" AND ",T=!0):2===(I=a[l].split("OR")).length&&""===I[0]&&(c=" OR ",T=!0),T){var O=o.makeWhere(n[a[l]],c,!0);i.push("("+O[0]+")"),s=s.concat(O[1])}}var y="";if(n.ORDER){a=Object.keys(n.ORDER);var m=[];for(l=0;l<a.length;l++){var D=n.ORDER[a[l]].toUpperCase();"ASC"!==D&&"DESC"!==D||m.push(e(a[l])+" "+D)}y=y+" ORDER BY "+m.join(", ")}n.LIMIT&&(isNaN(n.LIMIT[0])||isNaN(n.LIMIT[1])?isNaN(n.LIMIT)||(y=y+" LIMIT "+n.LIMIT):y=y+" LIMIT "+n.LIMIT[1]+" OFFSET "+n.LIMIT[0]);var S="";return 0!==i.length&&(t||(S=" WHERE "),S+=i.join(r||c)),[S+y,s]},o.createTable=function(n,r,t,i){for(var s=Object.keys(r),a=0;a<s.length;a++)"Array"===r[s[a]].constructor.name?s[a]=e(s[a])+" "+r[s[a]][0].toUpperCase()+" "+e(r[s[a]][1]):s[a]=e(s[a])+" "+String(r[s[a]]).toUpperCase();var c="CREATE TABLE IF NOT EXISTS "+e(n)+" ("+s.join(", ")+")";o.SQLQuery(c,[],t,i)},o.select=function(n,r,t,i,s){var a=r;if("*"!==r)for(var u=0;u<a.length;u++)a[u]=e(a[u]);else a=!1;var l=o.makeWhere(t),f="SELECT "+(a?a.join(", "):r)+" FROM "+e(n)+l[0];o.SQLQuery(f,l[1],function(e){if(i){if(0!==e.length&&c(n,"get",e[0]))for(var r=1;r<e.length;r++)c(n,"get",e[r]);i(e)}},s)},o.delete=function(n,r,t,i){if(r){var s=o.makeWhere(r),a="DELETE FROM "+e(n)+s[0];o.SQLQuery(a,s[1],t,i)}else{a="TRUNCATE TABLE "+e(n);o.SQLQuery(a,[],t,function(e){-1!==e.indexOf("syntax error")&&o.delete(n,[],t,i)})}},o.insert=function(n,r,t,i){var s=[],a=[],u=[],l=JSON.parse(JSON.stringify(r)),f=Object.keys(l);c(n,"set",l);for(var d=0;d<f.length;d++)s.push(e(f[d])),a.push("?"),u.push(l[f[d]]);var b="INSERT INTO "+e(n)+" ("+s.join(", ")+") VALUES ("+a.join(", ")+")";o.SQLQuery(b,u,t,i)},o.update=function(n,r,t,i,s){var a=o.makeWhere(t),u=[],l=[],f=JSON.parse(JSON.stringify(r)),d=Object.keys(f);c(n,"set",f);for(var b=0;b<d.length;b++)u.push(e(d[b])+" = ?"),l.push(f[d[b]]);var p="UPDATE "+e(n)+" SET "+u.join(", ")+a[0];o.SQLQuery(p,l.concat(a[1]),i,s)},o.drop=function(n,r,t){o.SQLQuery("DROP TABLE "+e(n),[],r,t)},o.closeDatabase=function(){o.polyfill||o.db.close(function(){},function(e){var n="Error closing Database:"+e.message;errorCallback?errorCallback(n):console.error(n)})}}function b(n){var r,i,s,a;r=function e(n,r,o){for(var t=!o,s=Object.keys(r),a=0;a<s.length;a++){var c=s[a].match(/([a-zA-Z0-9_\.]+)(\[(\>\=?|\<\=?|\!|\<\>|\>\<|\!?~)\])?/),u=c[1].toLowerCase();if("AND"!==u&&"OR"!==u){var l=r[s[a]],f=!0;if("AND"===c[1])f=e(n,r[s[a]],!1);else if("OR"===c[1])f=e(n,r[s[a]],!0);else if(void 0===c[3])l instanceof Array?-1===l.indexOf(n[c[1]])&&(f=!1):n[c[1]]!=l&&(f=!1);else if("!"===c[3])l instanceof Array?-1!==l.indexOf(n[c[1]])&&(f=!1):n[c[1]]==l&&(f=!1);else if(">"===c[3])n[c[1]]<=l&&(f=!1);else if(">="===c[3])n[c[1]]<l&&(f=!1);else if("<"===c[3])n[c[1]]>=l&&(f=!1);else if("<="===c[3])n[c[1]]>l&&(f=!1);else if("><"===c[3])(n[c[1]]<=l[0]||n[c[1]]>=l[1])&&(f=!1);else if("=><="===c[3])(n[c[1]]<l[0]||n[c[1]]>l[1])&&(f=!1);else if("<>"===c[3])(n[c[1]]>=l[0]||n[c[1]]<=l[1])&&(f=!1);else if("<=>"===c[3])(n[c[1]]>l[0]||n[c[1]]<l[1])&&(f=!1);else if(-1!==c[3].indexOf("~")){var d=1,b=[],p=l instanceof Array?l:[l];for(a=0;a<p.length;a++){var v=p[a];"%"===v[0]&&"%"===v.slice(-1)?(d=1,v=v.slice(1,-1)):"%"===v[0]?(d=2,v=v.slice(1)):"%"===v.slice(-1)&&(d=3,v=v.slice(0,-1)),v=v.replace(i,"\\$&"),2===d?v+="$":3===d&&(v="^"+v),b.push(v)}var h=n[c[1]].match(RegExp(b.join("|"),"i"));-1!==c[3].indexOf("!")?h&&(f=!1):h||(f=!1)}if(o)t=t||f;else if(!f){t=!1;break}}}return t},i=/[-\/\\^$*+?.()|[\]{}]/g,s=function(e){return e.found++,e.processed++,e.found>e.startFrom?e.processed<=e.limit?1:-1:0},a=function(e,n){var r={found:0,processed:0};if(void 0!==n.LIMIT?"number"==typeof n.LIMIT?(r.startFrom=0,r.limit=n.LIMIT):(r.startFrom=n.LIMIT[0],r.limit=n.LIMIT[1]):r.limit=!1,void 0!==n.ORDER)if("string"==typeof n.ORDER)r.cursor=e.index(n.ORDER).openCursor(null,"next");else for(var o in n.ORDER){"ASC"===n.ORDER[o]&&(r.cursor=e.index(o).openCursor(null,"next")),"DESC"===n.ORDER[o]&&(r.cursor=e.index(o).openCursor(null,"prev"));break}else r.cursor=e.openCursor();return delete n.LIMIT,delete n.ORDER,r},o.createTable=function(e,n,r,t){if(o.db.objectStoreNames.contains(e))return r(o);var i,s=Object.keys(n);try{for(var a=o.db.createObjectStore(e,{keyPath:"rowid",autoIncrement:!0}),c=0;c<s.length;c++){var u="string"!=typeof(i=s[c])?i:i.match(/[a-zA-Z0-9_\.]+/)[0]||"";n[s[c]]instanceof Array&&n[s[c]].length>=2?a.createIndex(u,u,{unique:"unique"===n[s[c]][1]}):a.createIndex(u,u,{unique:!1})}r&&r(o)}catch(e){t&&t(e)}},o.insert=function(e,n,r,t){var i=!1,s=o.getObjectStore(e,"readwrite",function(){i||(t||console.error)("table not found")}).add(n);s.onerror=function(){i=!0,(t||console.error)("duplicate on unique columns")},r&&(s.onsuccess=function(e){r(e.target.result)})},o.select=function(e,n,t,i,c){var u=o.getObjectStore(e,"readonly",c),l=a(u,t);l.cursor.onerror=c,l.result=[];var f=function(e){for(var r={},o=0;o<n.length;o++)r[n[o]]=e[n[o]];l.result.push(r)};l.cursor.onsuccess=function(e){var n=e.target.result;if(n){var o=n.value;if(r(o,t))if(!1!==l.limit){var a=s(l);if(-1===a)return void i(l.result);1===a&&f(o)}else f(o);n.continue()}else i(l.result)}},o.delete=function(e,n,t,i){var c=o.getObjectStore(e,"readwrite",i),u=a(c,n);u.cursor.onerror=i,u.cursor.onsuccess=function(e){var o=e.target.result;if(o){var i=o.value;if(r(i,n))if(!1!==u.limit){var a=s(u);if(-1===a)return void t(u.processed);1===a&&o.delete()}else u.processed++,o.delete();o.continue()}else t(u.processed)}},o.update=function(e,n,t,i,c){var u=o.getObjectStore(e,"readwrite",c),l=a(u,t);l.cursor.onerror=c;var f=Object.keys(n),d=function(e,r){for(var o=0;o<f.length;o++)r[f[o]]=n[f[o]];e.update(r)};l.cursor.onsuccess=function(e){var n=e.target.result;if(n){var o=n.value;if(r(o,t))if(!1!==l.limit){var a=s(l);if(-1===a)return void i(l.processed);1===a&&d(n,o)}else l.processed++,d(n,o);n.continue()}else i(l.processed)}},o.drop=function(e,n,r){o.closeDatabase(),l=function(){try{o.db.deleteObjectStore(e)}catch(e){}},o.initializeTable(n,r)},o.closeDatabase=function(){o.db.close()},window.indexedDB||(window.indexedDB=window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB),window.IDBTransaction||(window.IDBTransaction=window.webkitIDBTransaction||window.msIDBTransaction),window.IDBKeyRange||(window.IDBKeyRange=window.webkitIDBKeyRange||window.msIDBKeyRange),window.indexedDB&&window.IDBTransaction&&window.IDBKeyRange?(o.storage="indexeddb",o.db=window.indexedDB.open(e,1),o.db.onerror=n,o.db.onupgradeneeded=o.db.versionchange=function(e){o.db.result&&(o.db=o.db.result),f(function(){})},o.db.onsuccess=function(e){o.db.result&&(o.db=o.db.result),f(function(){t(o)})},o.getObjectStore=function(e,n,r){var t=o.db.transaction(e,n);return t.onerror=r||console.error,t.objectStore(e)}):n&&n()}function p(r){d(),o.SQLQuery=function(e,r,t,i){n.debug&&n.debug(e,r),o.db.transaction(function(n){n.executeSql(e,r,function(n,o){if(a(r),r=e=null,t){var i=o&&o.rows?o.rows:o;if(o&&o.rowsAffected&&!i.length)return t(o.rowsAffected),void(i=null);if(i.length){for(var s={length:i.length},c=0;c<i.length;c++)s[c]=i[c];i=null,t(s)}else t([])}},function(n,o){var t="Database Error: "+o.message;a(r),r=e=null,i?i(t):console.error(t)})},function(e){var n="Database Transaction Error: "+e.message;i?i(n):console.error(n)})},function n(t){!t&&window.sqlitePlugin?o.db=window.sqlitePlugin.openDatabase({name:e,location:"default"},f,function(){console.error_("Failed to initialize sqlitePlugin"),setTimeout(function(){n(!0)},500)}):window.openDatabase?(o.db=window.openDatabase(e,"1.0",e,1024),o.db&&setTimeout(f,500)):(console.error("WebSQL is not supported on this browser"),r&&r())}()}u||n.websql||b(function(){console.warn("Fallback to WebSQL"),p()}),u&&void 0===n.mysql&&(n.mysql=!0),n.mysql&&function(i){d();var s=require("mysql");o.db=s.createPool({host:n.host?n.host:"localhost",user:n.user?n.user:"root",password:n.password?n.password:"",database:e}),r&&o.db.on("connection",t);n.hideInitialization||console.log("Connecting to "+e+" database");o.SQLQuery=function(e,r,t,i){n.debug&&n.debug(e,r),o.db.getConnection(function(n,o){if(n)return o.release(),void(i?i(n):console.error(n));o.query(e,r,function(n,s){o.release(),a(r),r=null,e=null,!n&&t?setTimeout(function(){t(s)},0):n&&setTimeout(function(){var e={msg:n.sqlMessage,query:n.sql,code:n.code};i?i(e):console.error(e)},0)})})}}(),u||void 0!==n.websql||(n.websql=!0),n.websql&&p(function(){console.warn("Fallback to IndexedDB"),b()})}
//# sourceMappingURL=sfdatabase.min.js.map
