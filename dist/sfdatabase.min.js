/*
  SFDatabase-js
  SFDatabase-js is a database library that can help you
  build a SQL Query and execute it to the server from
  Nodejs or local browser with WebSQL.

  https://github.com/ScarletsFiction/SFDatabase-js
*/
"use strict";function SFDatabase(e,r,n){var t=this;t.db=null,t.pending=[],t.initialized=!1,r.databaseStructure&&console.warn("`options.databaseStructure` is deprecated, please use `options.structure` instead."),r.structure||(r.structure=r.databaseStructure),r||(r={debug:!1});var o=function(){t.initialized||(t.initialized=!0,n?setTimeout((function(){n(s)||s()}),1):s())},i=-1,s=function e(){if(!t.db)return clearTimeout(i),void(i=setTimeout(e,1e3));if(t.pending.length){for(var r=0;r<t.pending.length;r++)t.pending[r]();t.pending.splice(0)}},a=function(e){if(e&&"object"==typeof e){if(e instanceof Array)e.splice(0);else for(var r=Object.keys(e),n=0;n<r.length;n++)delete e[r[n]];e=null}};t.preprocessTable={};var u=function(e,r,n){var o=!1;if(!t.preprocessTable[e])return o;for(var i=Object.keys(t.preprocessTable[e]),s=0;s<i.length;s++)n[i[s]]&&t.preprocessTable[e][i[s]][r]&&(n[i[s]]=t.preprocessTable[e][i[s]][r](n[i[s]]),o=!0);return o},c="undefined"!=typeof process&&process.execPath;if(!c)var l=null,f=function(e){var n=Object.keys(r.structure),i=n.length,s=function(){0===--i&&(e?e():o(t))};setTimeout((function(){i>1&&console.error("Failed to initialize",i,"database structure")}),5e3);for(var a=0;a<n.length;a++)t.createTable(n[a],r.structure[n[a]],s);l&&(l(),l=null)};if(!c&&!r.websql){var d=function(e){console.error(e.target&&e.target.error.message||e)};v((function(e){if("function"!=typeof IDBOpenDBRequest)return console.warn("Fallback to WebSQL",e),b();d(e)}))}function v(n){function i(e){t.db.result&&(t.db=t.db.result),t.busy=[],f((function(){if(t.busy){for(var e=0;e<t.busy.length;e++)t.busy[e][0].apply(null,t.busy[1]);t.busy=!1}}))}!function(){var e=function e(r,n,t){for(var i=!t,s=Object.keys(n),a=0;a<s.length;a++){var u=s[a].match(/([a-zA-Z0-9_\.]+)(\[(\>\=?|\<\=?|\!|\<\>|\>\<|\!?~)\])?/),c=u[1].toLowerCase();if("AND"!==c&&"OR"!==c){var l=n[s[a]],f=!0;if("AND"===u[1])f=e(r,n[s[a]],!1);else if("OR"===u[1])f=e(r,n[s[a]],!0);else if(void 0===u[3])l instanceof Array?-1===l.indexOf(r[u[1]])&&(f=!1):r[u[1]]!=l&&(f=!1);else if("!"===u[3])l instanceof Array?-1!==l.indexOf(r[u[1]])&&(f=!1):r[u[1]]==l&&(f=!1);else if(">"===u[3])r[u[1]]<=l&&(f=!1);else if(">="===u[3])r[u[1]]<l&&(f=!1);else if("<"===u[3])r[u[1]]>=l&&(f=!1);else if("<="===u[3])r[u[1]]>l&&(f=!1);else if("><"===u[3])(r[u[1]]<=l[0]||r[u[1]]>=l[1])&&(f=!1);else if("=><="===u[3])(r[u[1]]<l[0]||r[u[1]]>l[1])&&(f=!1);else if("<>"===u[3])(r[u[1]]>=l[0]||r[u[1]]<=l[1])&&(f=!1);else if("<=>"===u[3])(r[u[1]]>l[0]||r[u[1]]<l[1])&&(f=!1);else if(-1!==u[3].indexOf("~")){for(var d=1,v=[],b=l instanceof Array?l:[l],p=0;p<b.length;p++){var h=b[p];"%"===h[0]&&"%"===h.slice(-1)?(d=1,h=h.slice(1,-1)):"%"===h[0]?(d=2,h=h.slice(1)):"%"===h.slice(-1)&&(d=3,h=h.slice(0,-1)),h=h.replace(o,"\\$&"),2===d?h+="$":3===d&&(h="^"+h),v.push(h)}var g=r[u[1]].match(RegExp(v.join("|"),"i"));-1!==u[3].indexOf("!")?g&&(f=!1):g||(f=!1)}if(t)i=i||f;else if(!f){i=!1;break}}}return i},n=r.structure,o=/[-\/\\^$*+?.()|[\]{}]/g,i=function(e){return e.found++,e.processed++,e.found>e.startFrom?e.processed<=e.limit?1:-1:0};function s(e,r,t){var o=n[e],i=void 0,s=null;if(t.constructor!==String&&(i=t,t=void 0),o)for(var a=Object.keys(r),c=0;c<a.length;c++){var l=a[c].split("[");if(void 0!==o[l[0]]&&(void 0===t||void 0!==t&&l[0]===t)){s=u(l,r[a[c]]);break}}if(void 0!==i){if(null!==s)try{return i.index(l).openCursor(s)}catch(e){return i.openCursor()}return i.openCursor()}return s}var a=function(e,r,o,i){var a=t.getObjectStore(e,r,(function(r){(i||console.error)(e,r.target?r.target.error:r)})),u={found:0,processed:0};if(a){if(void 0!==o.LIMIT?"number"==typeof o.LIMIT?(u.startFrom=0,u.limit=o.LIMIT):(u.startFrom=o.LIMIT[0],u.limit=o.LIMIT[1]):u.limit=!1,delete o.LIMIT,void 0!==o.ORDER){var c=o.ORDER;delete o.ORDER;var l=null;if("string"==typeof c){if(void 0!==n[e]||void 0!==n[e][c])l=s(e,o,c);u.request=a.index(c).openCursor(l,"next")}else{var f=Object.keys(c)[0];if(void 0!==n[e]||void 0!==n[e][f])l=s(e,o,f);"ASC"===c[f]&&(u.request=a.index(f).openCursor(l,"next")),"DESC"===c[f]&&(u.request=a.index(f).openCursor(l,"prev"))}}else u.request=s(e,o,a);return u}};function u(e,r){if(r.constructor===String){if(0===r.length)return null;r=r[0]}return r.constructor===Array&&r[0].constructor===String&&(r=[r[0],r[1]]),2===e.length?">]"===(e=e[1])?IDBKeyRange.upperBound(r):">=]"===e?IDBKeyRange.upperBound(r,!0):"<]"===e?IDBKeyRange.lowerBound(r):"<=]"===e?IDBKeyRange.lowerBound(r,!0):"><]"===e?IDBKeyRange.bound(r[0],r[1]):">=<]"===e?IDBKeyRange.bound(r[0],r[1],!0):null:IDBKeyRange.only(r)}t.createTable=function(e,r,n,o){if(null===l)return console.warn("`createTable` is unavailable because the database version need to be changed. Try changing the database structure on first initialization, and increment the version.");if(t.db.objectStoreNames.contains(e))n&&n(t);else{var i,s=Object.keys(r);try{for(var a=t.db.createObjectStore(e,{keyPath:"rowid",autoIncrement:!0}),u=0;u<s.length;u++)if("$"===s[u][0]){var c="string"!=typeof(i=s[u])?i:i.match(/[a-zA-Z0-9_\.]+/)[0]||"";r[s[u]]instanceof Array&&r[s[u]].length>=2?a.createIndex(c,c,{unique:"unique"===r[s[u]][1]}):a.createIndex(c,c,{unique:!1})}n&&n(t)}catch(e){o&&o(e)}}},t.insert=function(e,r,n,o){if(!1!==t.busy)return t.busy.push(t.insert,arguments);var i=!1,s=t.getObjectStore(e,"readwrite",(function(){i||(o||console.error)(e,"table was not found")}));if(s){var a=s.add(r);a.onerror=function(){i=!0,(o||console.error)("duplicate on unique columns")},n&&(a.onsuccess=function(e){n(e.target.result)})}},t.has=function(r,n,o,i){if(!1!==t.busy)return t.busy.push(t.has,arguments);var s=a(r,"readonly",n,i);if(s){var u=s.request;u.onerror=i,u.onsuccess=function(){var r=u.result;if(r){if(e(r.value,n))return void o(!0);r.continue()}else o&&o(!1)}}},t.cursor=function(e,r,n,o){if(!1!==t.busy)return t.busy.push(t.cursor,arguments);var i=t.getObjectStore(e,r&&r.WRITE?"readwrite":"readonly",o);if(i){if(r){var s="desc"===r.ORDER?"prev":"next";r.UNIQUE&&(s+="unique"),delete r.ORDER,delete r.UNIQUE;var a=Object.keys(r)[0],c=null;if(a){var l=a.split("[");i=i.index(l[0]);var f=r[l];c=u(l,f)}var d=i.openCursor(c,s)}else d=i.openCursor();return d.onerror=o,d.onsuccess=n,d}},t.get=function(r,n,o,i,s){if(!1!==t.busy)return t.busy.push(t.get,arguments);var u=a(r,"readonly",o,s);if(u){var c=u.request;c.onerror=s,c.onsuccess=function(){var r=c.result;if(r){var t=r.value;if(e(t,o)){if("*"===n)return void i(t);if(n.constructor===String)return void i(t[n]);for(var s={},a=0;a<n.length;a++)s[n[a]]=t[n[a]];return void i(s)}r.continue()}else i&&i(null)}}},t.select=function(r,n,o,s,u){if(!1!==t.busy)return t.busy.push(t.select,arguments);var c=a(r,"readonly",o,u);if(c){var l=c.request;l.onerror=u,c.result=[];var f=function(e){if("*"!==n)if(n.constructor!==String){for(var r={},t=0;t<n.length;t++)r[n[t]]=e[n[t]];c.result.push(r)}else c.result.push(e[n]);else c.result.push(e)};l.onsuccess=function(){var r=l.result;if(r){var n=r.value;if(e(n,o))if(!1!==c.limit){var t=i(c);if(-1===t)return void(s&&s(c.result));1===t&&f(n)}else f(n);r.continue()}else s&&s(c.result)}}},t.delete=function(r,n,o,s){if(!1!==t.busy)return t.busy.push(t.delete,arguments);if(!n){var u=t.getObjectStore(r,"readwrite",s);return u.onsuccess=o,u.clear()}var c=a(r,"readwrite",n,s);if(c){var l=c.request;l.onerror=s,l.onsuccess=function(){var r=l.result;if(r){var t=r.value;if(e(t,n))if(!1!==c.limit){var s=i(c);if(-1===s)return void(o&&o(c.processed));1===s&&r.delete()}else c.processed++,r.delete();r.continue()}else o&&o(c.processed)}}},t.update=function(r,n,o,s,u){if(!1!==t.busy)return t.busy.push(t.update,arguments);var c=a(r,"readwrite",o,u);if(c){var l=c.request;l.onerror=u;var f=Object.keys(n),d=function(e,r){for(var t=0;t<f.length;t++)r[f[t]]=n[f[t]];e.update(r)};l.onsuccess=function(){var r=l.result;if(r){var n=r.value;if(e(n,o))if(!1!==c.limit){var t=i(c);if(-1===t)return void(s&&s(c.processed));1===t&&d(r,n)}else c.processed++,d(r,n);r.continue()}else s&&s(c.processed)}}},t.drop=function(e,r,n){if(null===l)return console.warn("`drop` is unavailable because the database version need to be changed. Try changing the database structure on first initialization, and increment the version.");t.db.deleteObjectStore(e)},t.closeDatabase=function(){t.db.close()}}(),window.indexedDB||(window.indexedDB=window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB),window.IDBTransaction||(window.IDBTransaction=window.webkitIDBTransaction||window.msIDBTransaction),window.IDBKeyRange||(window.IDBKeyRange=window.webkitIDBKeyRange||window.msIDBKeyRange),window.indexedDB&&window.IDBTransaction&&window.IDBKeyRange?(t.busy=!1,t.storage="indexeddb",t.reopen=function(){l=function(){if(!r.websql)for(var e=t.db.objectStoreNames,n=0;n<e.length;n++)void 0===r.structure[e[n]]&&t.drop(e[n]);l=null},t.db=window.indexedDB.open(e,r.idbVersion||1),t.db.onupgradeneeded=t.db.onversionchange=i,t.db.onsuccess=function(e){t.db.result&&(t.db=t.db.result),o(t)}},t.reopen(),t.getObjectStore=function(e,r,n){try{var o=t.db.transaction(e,r)}catch(e){return void(n&&n(e))}return o.onerror=n||d,o.objectStore(e)}):n&&n("IndexedDB was not found")}function b(n){!function(){function e(e){return"`"+e.match(/[a-zA-Z0-9_\.]+/i)[0]+"`"}t.makeWhere=function(r,n,o){if(!r)return["",[]];for(var i=[],s=[],a=Object.keys(r),u=" AND ",c=["order","limit"],l=0;l<a.length;l++){var f=r[a[l]],d=a[l].match(/([a-zA-Z0-9_\.]+)(\[(\>\=?|\<\=?|\!|\<\>|\>\<|\!?~)\])?/),v=d[1].toLowerCase();if("and"!==v&&"or"!==v)if(o||-1===c.indexOf(v))if(d[3]){if(-1!==[">",">=","<","<="].indexOf(d[3])){if(!isNaN(f)){i.push(d[1]+" "+d[3]+" ?"),s.push(f);continue}var b="SQL where: value of "+d[1]+" is non-numeric and can't be accepted";console.error(b)}else if("!"===d[3]){var p;if(p=null!=f&&f.constructor)if(p===Array){for(var h=[],g=0;g<f.length;g++)h.push("?");i.push(d[1]+" NOT IN ("+h.join(", ")+")"),s=s.concat(f)}else p===Number||p===Boolean||p===String?(i.push(d[1]+" != ?"),s.push(f)):console.error("SQL where: value "+d[1]+" with type "+p.name+" can't be accepted");else i.push(d[1]+" IS NOT NULL")}else if("~"===d[3]||"!~"===d[3]){f.constructor!==Array&&(f=[f]);var y=[];for(g=0;g<f.length;g++)y.push(d[1]+("!~"===d[3]?" NOT":"")+" LIKE ?"),-1===f.indexOf("%")&&(f[g]="%"+f[g]+"%"),s.push(f[g]);i.push("("+y.join(" OR ")+")")}}else if(p=null!=f&&f.constructor)if(p===Array){for(h=[],g=0;g<f.length;g++)h.push("?");i.push(d[1]+" IN ("+h.join(", ")+")"),s=s.concat(f)}else p===Number||p===Boolean||p===String?(i.push(d[1]+" = ?"),s.push(f)):console.error("SQL where: value "+d[1]+" with type "+p.name+" can't be accepted");else i.push(d[1]+" IS NULL")}for(l=0;l<a.length;l++)if("ORDER"!==a[l]&&"LIMIT"!==a[l]){var w=a[l].split("AND"),I=!1;if(2===w.length&&""===w[0]?(u=" AND ",I=!0):2===(w=a[l].split("OR")).length&&""===w[0]&&(u=" OR ",I=!0),I){var T=t.makeWhere(r[a[l]],u,!0);i.push("("+T[0]+")"),s=s.concat(T[1])}}var O="";if(r.ORDER){a=Object.keys(r.ORDER);var D=[];for(l=0;l<a.length;l++){var S=r.ORDER[a[l]].toUpperCase();"ASC"!==S&&"DESC"!==S||D.push(e(a[l])+" "+S)}O=O+" ORDER BY "+D.join(", ")}r.LIMIT&&(isNaN(r.LIMIT[0])||isNaN(r.LIMIT[1])?isNaN(r.LIMIT)||(O=O+" LIMIT "+r.LIMIT):O=O+" LIMIT "+r.LIMIT[1]+" OFFSET "+r.LIMIT[0]);var m="";return 0!==i.length&&(o||(m=" WHERE "),m+=i.join(n||u)),[m+O,s]},t.createTable=function(r,n,o,i){for(var s=Object.keys(n),a=0;a<s.length;a++)"$"===s[a][0]&&(s[a]=s[a].slice(1)),n[s[a]].constructor===Array?s[a]=e(s[a])+" "+n[s[a]].join(" ").toUpperCase():s[a]=e(s[a])+" "+String(n[s[a]]).toUpperCase();var u="CREATE TABLE IF NOT EXISTS "+e(r)+" ("+s.join(", ")+")";t.SQLQuery(u,[],o,i)},t.select=function(r,n,o,i,s){var a=n;if("*"!==n){n.constructor===String&&(a=[n]);for(var c=0;c<a.length;c++)a[c]=e(a[c])}else a=!1;var l=t.makeWhere(o),f="SELECT "+(a?a.join(", "):n)+" FROM "+e(r)+l[0];t.SQLQuery(f,l[1],(function(e){if(0!==e.length&&u(r,"get",e[0]))for(var n=1;n<e.length;n++)u(r,"get",e[n]);i(e)}),s)},t.has=function(r,n,o,i){n.LIMIT=1;var s=t.makeWhere(n),a="SELECT 1 FROM "+e(r)+s[0];t.SQLQuery(a,s[1],(function(e){if(0!==e.length)return o(!0);o(!1)}),i)},t.get=function(e,r,n,o,i){n.LIMIT=1,t.select(e,r,n,(function(e){0===e.length?o(null):r.constructor===Array?o(e[0]):o(e[0][r])}),i)},t.delete=function(r,n,o,i){if(n){var s=t.makeWhere(n),a="DELETE FROM "+e(r)+s[0];t.SQLQuery(a,s[1],o,i)}else{a="TRUNCATE TABLE "+e(r);t.SQLQuery(a,[],o,(function(e){-1!==e.indexOf("syntax error")&&t.delete(r,[],o,i)}))}},t.insert=function(r,n,o,i){var s=[],a=[],c=[],l=JSON.parse(JSON.stringify(n)),f=Object.keys(l);u(r,"set",l);for(var d=0;d<f.length;d++)s.push(e(f[d])),a.push("?"),c.push(l[f[d]]);var v="INSERT INTO "+e(r)+" ("+s.join(", ")+") VALUES ("+a.join(", ")+")";t.SQLQuery(v,c,o,i)},t.update=function(r,n,o,i,s){var a=t.makeWhere(o),c=[],l=[],f=JSON.parse(JSON.stringify(n)),d=Object.keys(f);u(r,"set",f);for(var v=0;v<d.length;v++)c.push(e(d[v])+" = ?"),l.push(f[d[v]]);var b="UPDATE "+e(r)+" SET "+c.join(", ")+a[0];t.SQLQuery(b,l.concat(a[1]),i,s)},t.drop=function(r,n,o){t.SQLQuery("DROP TABLE "+e(r),[],n,o)},t.closeDatabase=function(){t.polyfill||t.db.close((function(){}),(function(e){var r="Error closing Database:"+e.message;errorCallback?errorCallback(r):console.error(r)}))}}(),t.SQLQuery=function(e,n,o,i){r.debug&&r.debug(e,n),t.db.transaction((function(r){r.executeSql(e,n,(function(r,t){if(a(n),n=e=null,o){var i=t&&t.rows?t.rows:t;if(t&&t.rowsAffected&&!i.length)return o(t.rowsAffected),void(i=null);if(i.length){for(var s={length:i.length},u=0;u<i.length;u++)s[u]=i[u];i=null,o(s)}else o([])}}),(function(r,t){var o="Database Error: "+t.message;a(n),n=e=null,i?i(o):console.error(o)}))}),(function(e){var r="Database Transaction Error: "+e.message;i?i(r):console.error(r)}))},function r(o){!o&&window.sqlitePlugin?t.db=window.sqlitePlugin.openDatabase({name:e,location:"default"},f,(function(){console.error_("Failed to initialize sqlitePlugin"),setTimeout((function(){r(!0)}),500)})):window.openDatabase?(t.db=window.openDatabase(e,"1.0",e,1024),t.db&&setTimeout(f,500)):(console.error("WebSQL is not supported on this browser"),n&&n())}()}c||void 0!==r.websql||(r.websql=!0),r.websql&&b((function(){console.warn("Fallback to IndexedDB"),v()}))}"undefined"!=typeof process&&process.execPath&&(module.exports=SFDatabase);
//# sourceMappingURL=SFDatabase.min.js.map
