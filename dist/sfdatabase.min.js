/*
  SFDatabase-js
  SFDatabase-js is a database library that can help you
  build a SQL Query and execute it to the server from
  Nodejs or local browser with WebSQL.

  https://github.com/ScarletsFiction/SFDatabase-js
*/
"use strict";function SFDatabase(e,r,n){var t=this;t.db=null,t.pending=[],t.initialized=!1,r||(r={debug:!1});var o=function(){t.initialized||(t.initialized=!0,n?setTimeout(function(){n(s)||s()},1):s())},i=-1,s=function e(){if(!t.db)return clearTimeout(i),void(i=setTimeout(e,1e3));if(t.pending.length){for(var r=0;r<t.pending.length;r++)t.pending[r]();t.pending.splice(0)}},a=function(e){if(e&&"object"==typeof e){if(e instanceof Array)e.splice(0);else for(var r=Object.keys(e),n=0;n<r.length;n++)delete e[r[n]];e=null}};t.preprocessTable={};var c=function(e,r,n){var o=!1;if(!t.preprocessTable[e])return o;for(var i=Object.keys(t.preprocessTable[e]),s=0;s<i.length;s++)n[i[s]]&&t.preprocessTable[e][i[s]][r]&&(n[i[s]]=t.preprocessTable[e][i[s]][r](n[i[s]]),o=!0);return o},u="undefined"!=typeof process&&process.execPath;if(!u)var l=null,f=function(e){var n=Object.keys(r.databaseStructure),i=n.length,s=function(){0===--i&&(e?e():o(t))};setTimeout(function(){i>1&&console.error("Failed to initialize database structure")},5e3);for(var a=0;a<n.length;a++)t.createTable(n[a],r.databaseStructure[n[a]],s);l&&(l(),l=null)};function d(r){var n,i,s,a;n=function e(r,n,t){for(var o=!t,s=Object.keys(n),a=0;a<s.length;a++){var c=s[a].match(/([a-zA-Z0-9_\.]+)(\[(\>\=?|\<\=?|\!|\<\>|\>\<|\!?~)\])?/),u=c[1].toLowerCase();if("AND"!==u&&"OR"!==u){var l=n[s[a]],f=!0;if("AND"===c[1])f=e(r,n[s[a]],!1);else if("OR"===c[1])f=e(r,n[s[a]],!0);else if(void 0===c[3])l instanceof Array?-1===l.indexOf(r[c[1]])&&(f=!1):r[c[1]]!=l&&(f=!1);else if("!"===c[3])l instanceof Array?-1!==l.indexOf(r[c[1]])&&(f=!1):r[c[1]]==l&&(f=!1);else if(">"===c[3])r[c[1]]<=l&&(f=!1);else if(">="===c[3])r[c[1]]<l&&(f=!1);else if("<"===c[3])r[c[1]]>=l&&(f=!1);else if("<="===c[3])r[c[1]]>l&&(f=!1);else if("><"===c[3])(r[c[1]]<=l[0]||r[c[1]]>=l[1])&&(f=!1);else if("=><="===c[3])(r[c[1]]<l[0]||r[c[1]]>l[1])&&(f=!1);else if("<>"===c[3])(r[c[1]]>=l[0]||r[c[1]]<=l[1])&&(f=!1);else if("<=>"===c[3])(r[c[1]]>l[0]||r[c[1]]<l[1])&&(f=!1);else if(-1!==c[3].indexOf("~")){var d=1,p=[],b=l instanceof Array?l:[l];for(a=0;a<b.length;a++){var v=b[a];"%"===v[0]&&"%"===v.slice(-1)?(d=1,v=v.slice(1,-1)):"%"===v[0]?(d=2,v=v.slice(1)):"%"===v.slice(-1)&&(d=3,v=v.slice(0,-1)),v=v.replace(i,"\\$&"),2===d?v+="$":3===d&&(v="^"+v),p.push(v)}var h=r[c[1]].match(RegExp(p.join("|"),"i"));-1!==c[3].indexOf("!")?h&&(f=!1):h||(f=!1)}if(t)o=o||f;else if(!f){o=!1;break}}}return o},i=/[-\/\\^$*+?.()|[\]{}]/g,s=function(e){return e.found++,e.processed++,e.found>e.startFrom?e.processed<=e.limit?1:-1:0},a=function(e,r){var n={found:0,processed:0};if(void 0!==r.LIMIT?"number"==typeof r.LIMIT?(n.startFrom=0,n.limit=r.LIMIT):(n.startFrom=r.LIMIT[0],n.limit=r.LIMIT[1]):n.limit=!1,void 0!==r.ORDER)if("string"==typeof r.ORDER)n.cursor=e.index(r.ORDER).openCursor(null,"next");else for(var t in r.ORDER){"ASC"===r.ORDER[t]&&(n.cursor=e.index(t).openCursor(null,"next")),"DESC"===r.ORDER[t]&&(n.cursor=e.index(t).openCursor(null,"prev"));break}else n.cursor=e.openCursor();return delete r.LIMIT,delete r.ORDER,n},t.createTable=function(e,r,n,o){if(t.db.objectStoreNames.contains(e))return n(t);var i,s=Object.keys(r);try{for(var a=t.db.createObjectStore(e,{keyPath:"rowid",autoIncrement:!0}),c=0;c<s.length;c++){var u="string"!=typeof(i=s[c])?i:i.match(/[a-zA-Z0-9_\.]+/)[0]||"";r[s[c]]instanceof Array&&r[s[c]].length>=2?a.createIndex(u,u,{unique:"unique"===r[s[c]][1]}):a.createIndex(u,u,{unique:!1})}n&&n(t)}catch(e){o&&o(e)}},t.insert=function(e,r,n,o){var i=!1,s=t.getObjectStore(e,"readwrite",function(){i||(o||console.error)("table not found")}).add(r);s.onerror=function(){i=!0,(o||console.error)("duplicate on unique columns")},n&&(s.onsuccess=function(e){n(e.target.result)})},t.select=function(e,r,o,i,c){var u=t.getObjectStore(e,"readonly",c),l=a(u,o);l.cursor.onerror=c,l.result=[];var f=function(e){for(var n={},t=0;t<r.length;t++)n[r[t]]=e[r[t]];l.result.push(n)};l.cursor.onsuccess=function(e){var r=e.target.result;if(r){var t=r.value;if(n(t,o))if(!1!==l.limit){var a=s(l);if(-1===a)return void i(l.result);1===a&&f(t)}else f(t);r.continue()}else i(l.result)}},t.delete=function(e,r,o,i){var c=t.getObjectStore(e,"readwrite",i),u=a(c,r);u.cursor.onerror=i,u.cursor.onsuccess=function(e){var t=e.target.result;if(t){var i=t.value;if(n(i,r))if(!1!==u.limit){var a=s(u);if(-1===a)return void o(u.processed);1===a&&t.delete()}else u.processed++,t.delete();t.continue()}else o(u.processed)}},t.update=function(e,r,o,i,c){var u=t.getObjectStore(e,"readwrite",c),l=a(u,o);l.cursor.onerror=c;var f=Object.keys(r),d=function(e,n){for(var t=0;t<f.length;t++)n[f[t]]=r[f[t]];e.update(n)};l.cursor.onsuccess=function(e){var r=e.target.result;if(r){var t=r.value;if(n(t,o))if(!1!==l.limit){var a=s(l);if(-1===a)return void i(l.processed);1===a&&d(r,t)}else l.processed++,d(r,t);r.continue()}else i(l.processed)}},t.drop=function(e,r,n){t.closeDatabase(),l=function(){try{t.db.deleteObjectStore(e)}catch(e){}},t.initializeTable(r,n)},t.closeDatabase=function(){t.db.close()},window.indexedDB||(window.indexedDB=window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB),window.IDBTransaction||(window.IDBTransaction=window.webkitIDBTransaction||window.msIDBTransaction),window.IDBKeyRange||(window.IDBKeyRange=window.webkitIDBKeyRange||window.msIDBKeyRange),window.indexedDB&&window.IDBTransaction&&window.IDBKeyRange?(t.storage="indexeddb",t.db=window.indexedDB.open(e,1),t.db.onerror=r,t.db.onupgradeneeded=t.db.versionchange=function(e){t.db.result&&(t.db=t.db.result),f(function(){})},t.db.onsuccess=function(e){t.db.result&&(t.db=t.db.result),f(function(){o(t)})},t.getObjectStore=function(e,r,n){var o=t.db.transaction(e,r);return o.onerror=n||console.error,o.objectStore(e)}):r&&r()}function p(n){!function(){function e(e){return"`"+e.match(/[a-zA-Z0-9_\.]+/i)[0]+"`"}t.makeWhere=function(r,n,o){if(!r)return["",[]];for(var i=[],s=[],a=Object.keys(r),c=" AND ",u=["order","limit"],l=0;l<a.length;l++){var f=r[a[l]],d=a[l].match(/([a-zA-Z0-9_\.]+)(\[(\>\=?|\<\=?|\!|\<\>|\>\<|\!?~)\])?/),p=d[1].toLowerCase();if("and"!==p&&"or"!==p&&(o||-1===u.indexOf(p)))if(d[3]){if(-1!==[">",">=","<","<="].indexOf(d[3])){if(!isNaN(f)){i.push(d[1]+" "+d[3]+" ?"),s.push(f);continue}var b="SQL where: value of "+d[1]+" is non-numeric and can't be accepted";console.error(b)}else if("!"===d[3]){var v;if(v=null!=f&&f.constructor.name)if("Array"===v){for(var h=[],g=0;g<f.length;g++)h.push("?");i.push(d[1]+" NOT IN ("+h.join(", ")+")"),s=s.concat(f)}else"Number"===v||"Boolean"===v||"String"===v?(i.push(d[1]+" != ?"),s.push(f)):console.error("SQL where: value "+d[1]+" with type "+v+" can't be accepted");else i.push(d[1]+" IS NOT NULL")}else if("~"===d[3]||"!~"===d[3]){f.constructor!==Array&&(f=[f]);var w=[];for(g=0;g<f.length;g++)w.push(d[1]+("!~"===d[3]?" NOT":"")+" LIKE ?"),-1===f.indexOf("%")&&(f[g]="%"+f[g]+"%"),s.push(f[g]);i.push("("+w.join(" OR ")+")")}}else if(v=null!=f&&f.constructor.name)if("Array"===v){for(h=[],g=0;g<f.length;g++)h.push("?");i.push(d[1]+" IN ("+h.join(", ")+")"),s=s.concat(f)}else"Number"===v||"Boolean"===v||"String"===v?(i.push(d[1]+" = ?"),s.push(f)):console.error("SQL where: value "+d[1]+" with type "+v+" can't be accepted");else i.push(d[1]+" IS NULL")}for(l=0;l<a.length;l++)if("ORDER"!==a[l]&&"LIMIT"!==a[l]){var I=a[l].split("AND"),O=!1;if(2===I.length&&""===I[0]?(c=" AND ",O=!0):2===(I=a[l].split("OR")).length&&""===I[0]&&(c=" OR ",O=!0),O){var T=t.makeWhere(r[a[l]],c,!0);i.push("("+T[0]+")"),s=s.concat(T[1])}}var D="";if(r.ORDER){a=Object.keys(r.ORDER);var y=[];for(l=0;l<a.length;l++){var S=r.ORDER[a[l]].toUpperCase();"ASC"!==S&&"DESC"!==S||y.push(e(a[l])+" "+S)}D=D+" ORDER BY "+y.join(", ")}r.LIMIT&&(isNaN(r.LIMIT[0])||isNaN(r.LIMIT[1])?isNaN(r.LIMIT)||(D=D+" LIMIT "+r.LIMIT):D=D+" LIMIT "+r.LIMIT[1]+" OFFSET "+r.LIMIT[0]);var m="";return 0!==i.length&&(o||(m=" WHERE "),m+=i.join(n||c)),[m+D,s]},t.createTable=function(r,n,o,i){for(var s=Object.keys(n),a=0;a<s.length;a++)"Array"===n[s[a]].constructor.name?s[a]=e(s[a])+" "+n[s[a]].join(" ").toUpperCase():s[a]=e(s[a])+" "+String(n[s[a]]).toUpperCase();var c="CREATE TABLE IF NOT EXISTS "+e(r)+" ("+s.join(", ")+")";t.SQLQuery(c,[],o,i)},t.select=function(r,n,o,i,s){var a=n;if("*"!==n)for(var u=0;u<a.length;u++)a[u]=e(a[u]);else a=!1;var l=t.makeWhere(o),f="SELECT "+(a?a.join(", "):n)+" FROM "+e(r)+l[0];t.SQLQuery(f,l[1],function(e){if(i){if(0!==e.length&&c(r,"get",e[0]))for(var n=1;n<e.length;n++)c(r,"get",e[n]);i(e)}},s)},t.delete=function(r,n,o,i){if(n){var s=t.makeWhere(n),a="DELETE FROM "+e(r)+s[0];t.SQLQuery(a,s[1],o,i)}else a="TRUNCATE TABLE "+e(r),t.SQLQuery(a,[],o,function(e){-1!==e.indexOf("syntax error")&&t.delete(r,[],o,i)})},t.insert=function(r,n,o,i){var s=[],a=[],u=[],l=JSON.parse(JSON.stringify(n)),f=Object.keys(l);c(r,"set",l);for(var d=0;d<f.length;d++)s.push(e(f[d])),a.push("?"),u.push(l[f[d]]);var p="INSERT INTO "+e(r)+" ("+s.join(", ")+") VALUES ("+a.join(", ")+")";t.SQLQuery(p,u,o,i)},t.update=function(r,n,o,i,s){var a=t.makeWhere(o),u=[],l=[],f=JSON.parse(JSON.stringify(n)),d=Object.keys(f);c(r,"set",f);for(var p=0;p<d.length;p++)u.push(e(d[p])+" = ?"),l.push(f[d[p]]);var b="UPDATE "+e(r)+" SET "+u.join(", ")+a[0];t.SQLQuery(b,l.concat(a[1]),i,s)},t.drop=function(r,n,o){t.SQLQuery("DROP TABLE "+e(r),[],n,o)},t.closeDatabase=function(){t.polyfill||t.db.close(function(){},function(e){var r="Error closing Database:"+e.message;errorCallback?errorCallback(r):console.error(r)})}}(),t.SQLQuery=function(e,n,o,i){r.debug&&r.debug(e,n),t.db.transaction(function(r){r.executeSql(e,n,function(r,t){if(a(n),n=e=null,o){var i=t&&t.rows?t.rows:t;if(t&&t.rowsAffected&&!i.length)return o(t.rowsAffected),void(i=null);if(i.length){for(var s={length:i.length},c=0;c<i.length;c++)s[c]=i[c];i=null,o(s)}else o([])}},function(r,t){var o="Database Error: "+t.message;a(n),n=e=null,i?i(o):console.error(o)})},function(e){var r="Database Transaction Error: "+e.message;i?i(r):console.error(r)})},function r(o){!o&&window.sqlitePlugin?t.db=window.sqlitePlugin.openDatabase({name:e,location:"default"},f,function(){console.error_("Failed to initialize sqlitePlugin"),setTimeout(function(){r(!0)},500)}):window.openDatabase?(t.db=window.openDatabase(e,"1.0",e,1024),t.db&&setTimeout(f,500)):(console.error("WebSQL is not supported on this browser"),n&&n())}()}u||r.websql||d(function(){console.warn("Fallback to WebSQL"),p()}),u||void 0!==r.websql||(r.websql=!0),r.websql&&p(function(){console.warn("Fallback to IndexedDB"),d()})}"undefined"!=typeof process&&process.execPath&&(module.exports=SFDatabase);
//# sourceMappingURL=SFDatabase.min.js.map
