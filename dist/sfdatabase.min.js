/*
  SFDatabase-js
  SFDatabase-js is a database library that can help you
  build a SQL Query and execute it to the server from
  Nodejs or local browser with WebSQL.

  https://github.com/ScarletsFiction/SFDatabase-js
*/
"use strict";function SFDatabase(e,t,n){var r=this;r.db=null,r.pending=[],r.initialized=!1,t||(t={debug:!1});var a=function(){r.initialized||(r.initialized=!0,!!n&&n(o)||o())},i=-1,o=function e(){if(!r.db)return clearTimeout(i),void(i=setTimeout(e,1e3));if(r.pending.length){for(var t=0;t<r.pending.length;t++)r.pending[t]();r.pending.splice(0)}},s=function(e){if(e&&"object"==typeof e){if(e instanceof Array)e.splice(0);else for(var t=Object.keys(e),n=0;n<t.length;n++)delete e[t[n]];e=null}};r.preprocessTable={};var l=function(e,t,n){var a=!1;if(!r.preprocessTable[e])return a;for(var i=Object.keys(r.preprocessTable[e]),o=0;o<i.length;o++)n[i[o]]&&r.preprocessTable[e][i[o]][t]&&(n[i[o]]=r.preprocessTable[e][i[o]][t](n[i[o]]),a=!0);return a};r.validateText=function(e){return"`"+e.match(/[a-zA-Z0-9_\.]+/i)[0]+"`"};var c="undefined"!=typeof process&&process.execPath;function u(){r.makeWhere=function(e,t,n){if(!e)return["",[]];for(var a=[],i=[],o=Object.keys(e),s=" AND ",l=["order","limit"],c=0;c<o.length;c++){var u=e[o[c]],f=o[c].match(/([a-zA-Z0-9_\.]+)(\[(\>\=?|\<\=?|\!|\<\>|\>\<|\!?~)\])?/),d=f[1].toLowerCase();if("and"!==d&&"or"!==d)if(n||-1===l.indexOf(d))if(f[3]){if(-1!==[">",">=","<","<="].indexOf(f[3])){if(!isNaN(u)){a.push(f[1]+" "+f[3]+" ?"),i.push(u);continue}var v="SQL where: value of "+f[1]+" is non-numeric and can't be accepted";console.error(v)}else if("!"===f[3]){var h;if(h=null!=u&&u.constructor.name)if("Array"===h){for(var p=[],g=0;g<u.length;g++)p.push("?");a.push(f[1]+" NOT IN ("+p.join(", ")+")"),i=i.concat(u)}else"Number"===h||"Boolean"===h||"String"===h?(a.push(f[1]+" != ?"),i.push(u)):console.error("SQL where: value "+f[1]+" with type "+h+" can't be accepted");else a.push(f[1]+" IS NOT NULL")}else if("~"===f[3]||"!~"===f[3]){u.constructor!==Array&&(u=[u]);var b=[];for(g=0;g<u.length;g++)b.push(f[1]+("!~"===f[3]?" NOT":"")+" LIKE ?"),-1===u.indexOf("%")&&(u[g]="%"+u[g]+"%"),i.push(u[g]);a.push("("+b.join(" OR ")+")")}}else if(h=null!=u&&u.constructor.name)if("Array"===h){for(p=[],g=0;g<u.length;g++)p.push("?");a.push(f[1]+" IN ("+p.join(", ")+")"),i=i.concat(u)}else"Number"===h||"Boolean"===h||"String"===h?(a.push(f[1]+" = ?"),i.push(u)):console.error("SQL where: value "+f[1]+" with type "+h+" can't be accepted");else a.push(f[1]+" IS NULL")}for(c=0;c<o.length;c++)if("ORDER"!==o[c]&&"LIMIT"!==o[c]){var T=o[c].split("AND"),y=!1;if(2===T.length&&""===T[0]?(s=" AND ",y=!0):2===(T=o[c].split("OR")).length&&""===T[0]&&(s=" OR ",y=!0),y){var O=r.makeWhere(e[o[c]],s,!0);a.push("("+O[0]+")"),i=i.concat(O[1])}}var I="";if(e.ORDER){o=Object.keys(e.ORDER);var L=[];for(c=0;c<o.length;c++){var S=e.ORDER[o[c]].toUpperCase();"ASC"!==S&&"DESC"!==S||L.push(r.validateText(o[c])+" "+S)}I=I+" ORDER BY "+L.join(", ")}e.LIMIT&&(isNaN(e.LIMIT[0])||isNaN(e.LIMIT[1])?isNaN(e.LIMIT)||(I=I+" LIMIT "+e.LIMIT):I=I+" LIMIT "+e.LIMIT[1]+" OFFSET "+e.LIMIT[0]);var m="";return 0!==a.length&&(n||(m=" WHERE "),m+=a.join(t||s)),[m+I,i]},r.createTable=function(e,t,n,a){for(var i=Object.keys(t),o=0;o<i.length;o++)"Array"===t[i[o]].constructor.name?i[o]=r.validateText(i[o])+" "+t[i[o]][0].toUpperCase()+" "+r.validateText(t[i[o]][1]):i[o]=r.validateText(i[o])+" "+String(t[i[o]]).toUpperCase();var s="CREATE TABLE IF NOT EXISTS "+r.validateText(e)+" ("+i.join(", ")+")";r.SQLQuery(s,[],n,a)},r.select=function(e,t,n,a,i){var o=t;if("*"!==t)for(var s=0;s<o.length;s++)o[s]=r.validateText(o[s]);else o=!1;var c=r.makeWhere(n),u="SELECT "+(o?o.join(", "):t)+" FROM "+r.validateText(e)+c[0];r.SQLQuery(u,c[1],function(t){if(a){if(0!==t.length&&l(e,"get",t[0]))for(var n=1;n<t.length;n++)l(e,"get",t[n]);a(t)}},i)},r.delete=function(e,t,n,a){if(t){var i=r.makeWhere(t),o="DELETE FROM "+r.validateText(e)+i[0];r.SQLQuery(o,i[1],n,a)}else{o="TRUNCATE TABLE "+r.validateText(e);r.SQLQuery(o,[],n,function(t){-1!==t.indexOf("syntax error")&&r.delete(e,[],n,a)})}},r.insert=function(e,t,n,a){var i=[],o=[],s=[],c=JSON.parse(JSON.stringify(t)),u=Object.keys(c);l(e,"set",c);for(var f=0;f<u.length;f++)i.push(r.validateText(u[f])),o.push("?"),s.push(c[u[f]]);var d="INSERT INTO "+r.validateText(e)+" ("+i.join(", ")+") VALUES ("+o.join(", ")+")";r.SQLQuery(d,s,n,a)},r.update=function(e,t,n,a,i){var o=r.makeWhere(n),s=[],c=[],u=JSON.parse(JSON.stringify(t)),f=Object.keys(u);l(e,"set",u);for(var d=0;d<f.length;d++)s.push(r.validateText(f[d])+" = ?"),c.push(u[f[d]]);var v="UPDATE "+r.validateText(e)+" SET "+s.join(", ")+o[0];r.SQLQuery(v,c.concat(o[1]),a,i)},r.drop=function(e,t,n){r.SQLQuery("DROP TABLE "+r.validateText(e),[],t,n)},r.closeDatabase=function(){r.polyfill||r.db.close(function(){},function(e){var t="Error closing Database:"+e.message;errorCallback?errorCallback(t):console.error(t)})}}function f(e){var t,n;t=function e(t,n,r){for(var a=!r,i=Object.keys(n),o=0;o<i.length;o++){var s=columns[o].match(/([a-zA-Z0-9_\.]+)(\[(\>\=?|\<\=?|\!|\<\>|\>\<|\!?~)\])?/),l=s[1].toLowerCase();if("and"!==l&&"or"!==l&&(children||-1===specialList.indexOf(l))){var c=!0;if(">"===s[3])t[s[1]]<=n[i[o]]&&(c=!1);else if(">="===s[3])t[s[1]]<n[i[o]]&&(c=!1);else if("<"===s[3])t[s[1]]>=n[i[o]]&&(c=!1);else if("<="===s[3])t[s[1]]>n[i[o]]&&(c=!1);else if("><"===s[3])(t[s[1]]<=n[i[o]][0]||t[s[1]]>=n[i[o]][1])&&(c=!1);else if("=><="===s[3])(t[s[1]]<n[i[o]][0]||t[s[1]]>n[i[o]][1])&&(c=!1);else if("<>"===s[3])(t[s[1]]>=n[i[o]][0]||t[s[1]]<=n[i[o]][1])&&(c=!1);else if("<=>"===s[3])(t[s[1]]>n[i[o]][0]||t[s[1]]<n[i[o]][1])&&(c=!1);else if("AND"===s[1])c=e(t,n[i[o]],!1);else if("OR"===s[1])c=e(t,n[i[o]],!0);else if(1===operation.length)t[s[1]]!=n[i[o]]&&(c=!1);else if("!"===s[3])t[s[1]]==n[i[o]]&&(c=!1);else if(-1!==s[3].indexOf("~")){var u=1,f=n[i[o]];"%"===n[i[o]].slice(0,1)&&"%"===n[i[o]].slice(-1)?(u=1,f=f.slice(1,-1)):"%"===n[i[o]].slice(0,1)?(u=2,f=f.slice(1)):"%"===n[i[o]].slice(-1)&&(u=3,f=f.slice(0,-1)),f=f.replace(regexEscape,"\\$&"),2===u?f="^"+f:3===u&&(f+="$"),f=RegExp(f,"i"),-1!=s[3].indexOf("!")?t[s[1]].match(f)||(c=!1):t[s[1]].match(f)&&(c=!1)}if(r)a=a||c;else if(!c){a=!1;break}}}return a},n=function(e,n,r){if(r)return!(!n.ORDER&&!n.LIMIT);for(var a=Object.keys(n),i=0;i<a.length;i++)if("ORDER"==a[i]){var o=Object.keys(n.ORDER);for(i=0;i<o.length;i++)e.data.sort(sorterByKey(o[i],"DESC"==n.ORDER[o[i]]))}else"LIMIT"==a[i]&&("number"==typeof n.LIMIT?e.data=e.data.splice(0,n.LIMIT):e.data=e.data.splice(n.LIMIT[0],n.LIMIT[1]));if(delete n.LIMIT,delete n.ORDER,0!=Object.keys(n).length)for(i=e.data.length-1;i>=0;i--)t(e.data[i],n)||e.data.splice(i,1)},r.createTableRetry=!1,r.createTable=function(e,t,n,a){var i=Object.keys(t);try{for(var o=r.db.createObjectStore(e,{keyPath:"rowid",autoIncrement:!0}),s=0;s<i.length;s++){var l=validateText(i[s]);"Array"==t[i[s]].constructor.name&&t[i[s]].length>=2?o.createIndex(l,l,{unique:"unique"==t[i[s]][1]}):o.createIndex(l,l,{unique:!1})}n&&n(r)}catch(e){a&&a(e)}},r.insert=function(e,t,n,a){var i=!1,o=r.getObjectStore(e,"readwrite",function(){!i&&a&&a("table not found")}).add(t);a&&(o.onerror=function(){i=!0,a("duplicate on unique columns")}),n&&(o.onsuccess=function(e){n(e.target.result)})},r.select=function(e,a,i,o,s){var l=r.getObjectStore(e,"readonly",s).openCursor(),c=n(null,i,!0),u=[],f={data:[]},d=function(e){for(var t={},n=0;n<a.length;n++)t[a[n]]=e[a[n]];u.push(t)};l.onerror=s,l.onsuccess=function(e){var r=e.target.result;if(r){var a=r.value;c?f.data.push(a):t(a,i)&&d(a),r.continue()}else{if(c){n(f,i,!1);for(var s=0;s<f.data.length;s++)d(f.data[s])}o(u)}}},r.delete=function(e,a,i,o){var s=r.getObjectStore(e,"readwrite",o),l=s.openCursor(),c=0,u=n(null,a,!0),f={data:[]};l.onerror=o,l.onsuccess=function(e){var r=e.target.result;if(r){var o=r.value;u?f.data.push(o):t(o,a)&&(c++,r.delete()),r.continue()}else if(u){n(f,a,!1);for(var l=0;l<f.data.length;l++)s.delete(f.data[l][s.keyPath]);i&&i(f.data.length)}else i&&i(c)}},r.update=function(e,a,i,o,s){var l=Object.keys(a),c=r.getObjectStore(e,"readwrite",s),u=c.openCursor(),f=0,d=n(null,i,!0),v={data:[]};u.onerror=s;var h=function(e){for(var t=0;t<l.length;t++)e[l[t]]=a[l[t]];f++};u.onsuccess=function(e){var r=e.target.result;if(r){var a=r.value;d?v.data.push(a):t(a,i)&&(h(a),r.update(a)),r.continue()}else{if(d){n(v,i,!1);for(var s=0;s<v.data.length;s++)h(v.data[s]),c.put(v.data[s])}o&&o(f)}}},r.drop=function(e,t,n){r.closeDatabase(),onStructureInitialize=function(){try{r.db.deleteObjectStore(e)}catch(e){}},r.initializeTable(t,n)},r.closeDatabase=function(){r.db.close()},r.getObjectStore=function(e,t,n){var a=r.db.transaction(e,t);return a.onerror=n,a.objectStore(e)}}function d(n){u();var l=function(e){r.initialized=!0,r.SQLQuery("select 1",[],function(e){r.initialized=!1,e.length&&a(r)},function(){r.initialized=!1,e()})};r.SQLQuery=function(e,n,a,l){if(!r.initialized)return r.pending.push(function(){r.SQLQuery(e,n,a,l)}),clearTimeout(i),void(i=setTimeout(o,1e3));t.debug&&t.debug(e,n),r.db.transaction(function(t){t.executeSql(e,n,function(t,r){if(s(n),n=e=null,a){var i=r&&r.rows?r.rows:r;if(r&&r.rowsAffected&&!i.length)return a(r.rowsAffected),void(i=null);if(i.length){for(var o={length:i.length},l=0;l<i.length;l++)o[l]=i[l];i=null,a(o)}else a([])}},function(t,r){var a="Database Error: "+r.message;s(n),n=e=null,l?l(a):console.error(a)})},function(e){var t="Database Transaction Error: "+e.message;l?l(t):console.error(t)})},t.websql?window.sqlitePlugin?(r.db=window.sqlitePlugin.openDatabase({name:e,location:"default"}),l(function(e){console.error("Failed to initialize sqlitePlugin"),window.sqlitePlugin=!1,n&&n()})):window.openDatabase?(r.db=window.openDatabase(e,"1.0",e,1024),l(function(e){console.error("Failed to initialize WebSQL"),window.openDatabase=!1,t.websql=!1,n&&n()})):n&&n():(console.error("WebSQL is not supported on this browser"),n&&n())}c||t.websql||f(function(){d()}),c&&void 0===t.mysql&&(t.mysql=!0),t.mysql&&function(l){u();var c=require("mysql");r.db=c.createPool({host:t.host?t.host:"localhost",user:t.user?t.user:"root",password:t.password?t.password:"",database:e}),n&&r.db.on("connection",a);t.hideInitialization||console.log("Connecting to "+e+" database");r.SQLQuery=function(e,n,a,l){if(!r.initialized)return r.pending.push(function(){r.SQLQuery(e,n,a,l)}),clearTimeout(i),void(i=setTimeout(o,1e3));t.debug&&t.debug(e,n),r.db.getConnection(function(t,r){if(t)return r.release(),void(l?l(t):console.error(t));r.query(e,n,function(t,i){r.release(),s(n),n=null,e=null,!t&&a?setTimeout(function(){a(i)},0):t&&setTimeout(function(){var e={msg:t.sqlMessage,query:t.sql,code:t.code};l?l(e):console.error(e)},0)})})}}(),c||void 0!==t.websql||(t.websql=!0),t.websql&&d(function(){f()})}
//# sourceMappingURL=sfdatabase.min.js.map
