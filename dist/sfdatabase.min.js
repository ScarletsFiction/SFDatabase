/*
  SFDatabase-js
  SFDatabase-js is a database library that can help you
  build a SQL Query and execute it to the server from
  Nodejs or local browser with WebSQL.

  https://github.com/ScarletsFiction/SFDatabase-js
*/
"use strict";function SFDatabase(e,r,n){var t=this;t.db=null,t.pending=[],t.initialized=!1,r.databaseStructure&&console.warn("`options.databaseStructure` is deprecated, please use `options.structure` instead."),r.structure||(r.structure=r.databaseStructure),r||(r={debug:!1});var o=function(){t.initialized||(t.initialized=!0,n?setTimeout(function(){n(a)||a()},1):a())},i=-1,a=function e(){if(!t.db)return clearTimeout(i),void(i=setTimeout(e,1e3));if(t.pending.length){for(var r=0;r<t.pending.length;r++)t.pending[r]();t.pending.splice(0)}},s=function(e){if(e&&"object"==typeof e){if(e instanceof Array)e.splice(0);else for(var r=Object.keys(e),n=0;n<r.length;n++)delete e[r[n]];e=null}};t.preprocessTable={};var u=function(e,r,n){var o=!1;if(!t.preprocessTable[e])return o;for(var i=Object.keys(t.preprocessTable[e]),a=0;a<i.length;a++)n[i[a]]&&t.preprocessTable[e][i[a]][r]&&(n[i[a]]=t.preprocessTable[e][i[a]][r](n[i[a]]),o=!0);return o},c="undefined"!=typeof process&&process.execPath;if(!c)var l=null,f=function(e){var n=Object.keys(r.structure),i=n.length,a=function(){0===--i&&(e?e():o(t))};setTimeout(function(){i>1&&console.error("Failed to initialize",i,"database structure")},5e3);for(var s=0;s<n.length;s++)t.createTable(n[s],r.structure[n[s]],a);l&&(l(),l=null)};if(!c&&!r.websql){var d=function(e){console.error(e.target&&e.target.error.message||e)};v(function(e){if("function"!=typeof IDBOpenDBRequest)return console.warn("Fallback to WebSQL",e),p();d(e)})}function v(n){function i(e){t.db.result&&(t.db=t.db.result),f(function(){})}!function(){var e=function e(r,n,t){for(var i=!t,a=Object.keys(n),s=0;s<a.length;s++){var u=a[s].match(/([a-zA-Z0-9_\.]+)(\[(\>\=?|\<\=?|\!|\<\>|\>\<|\!?~)\])?/),c=u[1].toLowerCase();if("AND"!==c&&"OR"!==c){var l=n[a[s]],f=!0;if("AND"===u[1])f=e(r,n[a[s]],!1);else if("OR"===u[1])f=e(r,n[a[s]],!0);else if(void 0===u[3])l instanceof Array?-1===l.indexOf(r[u[1]])&&(f=!1):r[u[1]]!=l&&(f=!1);else if("!"===u[3])l instanceof Array?-1!==l.indexOf(r[u[1]])&&(f=!1):r[u[1]]==l&&(f=!1);else if(">"===u[3])r[u[1]]<=l&&(f=!1);else if(">="===u[3])r[u[1]]<l&&(f=!1);else if("<"===u[3])r[u[1]]>=l&&(f=!1);else if("<="===u[3])r[u[1]]>l&&(f=!1);else if("><"===u[3])(r[u[1]]<=l[0]||r[u[1]]>=l[1])&&(f=!1);else if("=><="===u[3])(r[u[1]]<l[0]||r[u[1]]>l[1])&&(f=!1);else if("<>"===u[3])(r[u[1]]>=l[0]||r[u[1]]<=l[1])&&(f=!1);else if("<=>"===u[3])(r[u[1]]>l[0]||r[u[1]]<l[1])&&(f=!1);else if(-1!==u[3].indexOf("~")){for(var d=1,v=[],p=l instanceof Array?l:[l],b=0;b<p.length;b++){var g=p[b];"%"===g[0]&&"%"===g.slice(-1)?(d=1,g=g.slice(1,-1)):"%"===g[0]?(d=2,g=g.slice(1)):"%"===g.slice(-1)&&(d=3,g=g.slice(0,-1)),g=g.replace(o,"\\$&"),2===d?g+="$":3===d&&(g="^"+g),v.push(g)}var h=r[u[1]].match(RegExp(v.join("|"),"i"));-1!==u[3].indexOf("!")?h&&(f=!1):h||(f=!1)}if(t)i=i||f;else if(!f){i=!1;break}}}return i},n=r.structure,o=/[-\/\\^$*+?.()|[\]{}]/g,i=function(e){return e.found++,e.processed++,e.found>e.startFrom?e.processed<=e.limit?1:-1:0};function a(e,r,t){var o=n[e],i=void 0,a=null;if(t.constructor!==String&&(i=t,t=void 0),o)for(var s=Object.keys(r),c=0;c<s.length;c++){var l=s[c].split("[");if(void 0!==o[l[0]]&&(void 0===t||void 0!==t&&l[0]===t)){a=u(l,r[s[c]]);break}}if(void 0!==i){if(null!==a)try{return i.index(l).openCursor(a)}catch(e){return i.openCursor()}return i.openCursor()}return a}var s=function(e,r,o,i){var s=t.getObjectStore(e,r,function(r){(i||console.error)(e,r.target?r.target.error:r)}),u={found:0,processed:0};if(s){if(void 0!==o.LIMIT?"number"==typeof o.LIMIT?(u.startFrom=0,u.limit=o.LIMIT):(u.startFrom=o.LIMIT[0],u.limit=o.LIMIT[1]):u.limit=!1,delete o.LIMIT,void 0!==o.ORDER){var c=o.ORDER;delete o.ORDER;var l=null;if("string"==typeof c)void 0===n[e]&&void 0===n[e][c]||(l=a(e,o,c)),u.request=s.index(c).openCursor(l,"next");else{var f=Object.keys(c)[0];void 0===n[e]&&void 0===n[e][f]||(l=a(e,o,f)),"ASC"===c[f]&&(u.request=s.index(f).openCursor(l,"next")),"DESC"===c[f]&&(u.request=s.index(f).openCursor(l,"prev"))}}else u.request=a(e,o,s);return u}};function u(e,r){if(r.constructor===String){if(0===r.length)return null;r=r[0]}return r.constructor===Array&&r[0].constructor===String&&(r=[r[0],r[1]]),2===e.length?">]"===(e=e[1])?IDBKeyRange.upperBound(r):">=]"===e?IDBKeyRange.upperBound(r,!0):"<]"===e?IDBKeyRange.lowerBound(r):"<=]"===e?IDBKeyRange.lowerBound(r,!0):"><]"===e?IDBKeyRange.bound(r[0],r[1]):">=<]"===e?IDBKeyRange.bound(r[0],r[1],!0):null:IDBKeyRange.only(r)}t.createTable=function(e,r,n,o){if(null===l)return console.warn("`createTable` is unavailable because the database version need to be changed. Try changing the database structure on first initialization, and increment the version.");if(t.db.objectStoreNames.contains(e))n&&n(t);else{var i,a=Object.keys(r);try{for(var s=t.db.createObjectStore(e,{keyPath:"rowid",autoIncrement:!0}),u=0;u<a.length;u++)if("$"===a[u][0]){var c="string"!=typeof(i=a[u])?i:i.match(/[a-zA-Z0-9_\.]+/)[0]||"";r[a[u]]instanceof Array&&r[a[u]].length>=2?s.createIndex(c,c,{unique:"unique"===r[a[u]][1]}):s.createIndex(c,c,{unique:!1})}n&&n(t)}catch(e){o&&o(e)}}},t.insert=function(e,r,n,o){var i=!1,a=t.getObjectStore(e,"readwrite",function(){i||(o||console.error)(e,"table was not found")});if(a){var s=a.add(r);s.onerror=function(){i=!0,(o||console.error)("duplicate on unique columns")},n&&(s.onsuccess=function(e){n(e.target.result)})}},t.has=function(r,n,t,o){var i=s(r,"readonly",n,o);if(i){var a=i.request;a.onerror=o,a.onsuccess=function(){var r=a.result;if(r){if(e(r.value,n))return void t(!0);r.continue()}else t&&t(!1)}}},t.cursor=function(e,r,n){var o=t.getObjectStore(e,r&&r.WRITE?"readwrite":"readonly",d);if(o){if(r){var i="desc"===r.ORDER?"prev":"next";r.UNIQUE&&(i+="unique"),delete r.ORDER,delete r.UNIQUE;var a=Object.keys(r)[0],s=null;if(a){var c=a.split("[");o=o.index(c[0]),s=u(c,r[c])}var l=o.openCursor(s,i)}else l=o.openCursor();return l.onerror=d,l.onsuccess=n,l}},t.get=function(r,n,t,o,i){var a=s(r,"readonly",t,i);if(a){var u=a.request;u.onerror=i,u.onsuccess=function(){var r=u.result;if(r){var i=r.value;if(e(i,t)){if("*"===n)return void o(i);if(n.constructor===String)return void o(i[n]);for(var a={},s=0;s<n.length;s++)a[n[s]]=i[n[s]];return void o(a)}r.continue()}else o&&o(null)}}},t.select=function(r,n,t,o,a){var u=s(r,"readonly",t,a);if(u){var c=u.request;c.onerror=a,u.result=[];var l=function(e){if("*"!==n)if(n.constructor!==String){for(var r={},t=0;t<n.length;t++)r[n[t]]=e[n[t]];u.result.push(r)}else u.result.push(e[n]);else u.result.push(e)};c.onsuccess=function(){var r=c.result;if(r){var n=r.value;if(e(n,t))if(!1!==u.limit){var a=i(u);if(-1===a)return void(o&&o(u.result));1===a&&l(n)}else l(n);r.continue()}else o&&o(u.result)}}},t.delete=function(r,n,o,a){if(!n){var u=t.getObjectStore(r,"readwrite",a);return u.onsuccess=o,u.clear()}var c=s(r,"readwrite",n,a);if(c){var l=c.request;l.onerror=a,l.onsuccess=function(){var r=l.result;if(r){var t=r.value;if(e(t,n))if(!1!==c.limit){var a=i(c);if(-1===a)return void(o&&o(c.processed));1===a&&r.delete()}else c.processed++,r.delete();r.continue()}else o&&o(c.processed)}}},t.update=function(r,n,t,o,a){var u=s(r,"readwrite",t,a);if(u){var c=u.request;c.onerror=a;var l=Object.keys(n),f=function(e,r){for(var t=0;t<l.length;t++)r[l[t]]=n[l[t]];e.update(r)};c.onsuccess=function(){var r=c.result;if(r){var n=r.value;if(e(n,t))if(!1!==u.limit){var a=i(u);if(-1===a)return void(o&&o(u.processed));1===a&&f(r,n)}else u.processed++,f(r,n);r.continue()}else o&&o(u.processed)}}},t.drop=function(e,r,n){if(null===l)return console.warn("`drop` is unavailable because the database version need to be changed. Try changing the database structure on first initialization, and increment the version.");t.db.deleteObjectStore(e)},t.closeDatabase=function(){t.db.close()}}(),window.indexedDB||(window.indexedDB=window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB),window.IDBTransaction||(window.IDBTransaction=window.webkitIDBTransaction||window.msIDBTransaction),window.IDBKeyRange||(window.IDBKeyRange=window.webkitIDBKeyRange||window.msIDBKeyRange),window.indexedDB&&window.IDBTransaction&&window.IDBKeyRange?(t.storage="indexeddb",t.reopen=function(){l=function(){if(!r.websql)for(var e=t.db.objectStoreNames,n=0;n<e.length;n++)void 0===r.structure[e[n]]&&t.drop(e[n]);l=null},t.db=window.indexedDB.open(e,r.idbVersion||1),t.db.onupgradeneeded=t.db.onversionchange=i,t.db.onerror=d,t.db.onsuccess=function(e){t.db.result&&(t.db=t.db.result,t.db.onerror=d),o(t)}},t.reopen(),t.getObjectStore=function(e,r,n){try{var o=t.db.transaction(e,r)}catch(e){return void(n&&n(e))}return o.onerror=n||d,o.objectStore(e)}):n&&n("IndexedDB was not found")}function p(n){!function(){function e(e){return"`"+e.match(/[a-zA-Z0-9_\.]+/i)[0]+"`"}t.makeWhere=function(r,n,o){if(!r)return["",[]];for(var i=[],a=[],s=Object.keys(r),u=" AND ",c=["order","limit"],l=0;l<s.length;l++){var f=r[s[l]],d=s[l].match(/([a-zA-Z0-9_\.]+)(\[(\>\=?|\<\=?|\!|\<\>|\>\<|\!?~)\])?/),v=d[1].toLowerCase();if("and"!==v&&"or"!==v&&(o||-1===c.indexOf(v)))if(d[3]){if(-1!==[">",">=","<","<="].indexOf(d[3])){if(!isNaN(f)){i.push(d[1]+" "+d[3]+" ?"),a.push(f);continue}var p="SQL where: value of "+d[1]+" is non-numeric and can't be accepted";console.error(p)}else if("!"===d[3]){var b;if(b=null!=f&&f.constructor)if(b===Array){for(var g=[],h=0;h<f.length;h++)g.push("?");i.push(d[1]+" NOT IN ("+g.join(", ")+")"),a=a.concat(f)}else b===Number||b===Boolean||b===String?(i.push(d[1]+" != ?"),a.push(f)):console.error("SQL where: value "+d[1]+" with type "+b.name+" can't be accepted");else i.push(d[1]+" IS NOT NULL")}else if("~"===d[3]||"!~"===d[3]){f.constructor!==Array&&(f=[f]);var w=[];for(h=0;h<f.length;h++)w.push(d[1]+("!~"===d[3]?" NOT":"")+" LIKE ?"),-1===f.indexOf("%")&&(f[h]="%"+f[h]+"%"),a.push(f[h]);i.push("("+w.join(" OR ")+")")}}else if(b=null!=f&&f.constructor)if(b===Array){for(g=[],h=0;h<f.length;h++)g.push("?");i.push(d[1]+" IN ("+g.join(", ")+")"),a=a.concat(f)}else b===Number||b===Boolean||b===String?(i.push(d[1]+" = ?"),a.push(f)):console.error("SQL where: value "+d[1]+" with type "+b.name+" can't be accepted");else i.push(d[1]+" IS NULL")}for(l=0;l<s.length;l++)if("ORDER"!==s[l]&&"LIMIT"!==s[l]){var I=s[l].split("AND"),y=!1;if(2===I.length&&""===I[0]?(u=" AND ",y=!0):2===(I=s[l].split("OR")).length&&""===I[0]&&(u=" OR ",y=!0),y){var T=t.makeWhere(r[s[l]],u,!0);i.push("("+T[0]+")"),a=a.concat(T[1])}}var O="";if(r.ORDER){s=Object.keys(r.ORDER);var D=[];for(l=0;l<s.length;l++){var S=r.ORDER[s[l]].toUpperCase();"ASC"!==S&&"DESC"!==S||D.push(e(s[l])+" "+S)}O=O+" ORDER BY "+D.join(", ")}r.LIMIT&&(isNaN(r.LIMIT[0])||isNaN(r.LIMIT[1])?isNaN(r.LIMIT)||(O=O+" LIMIT "+r.LIMIT):O=O+" LIMIT "+r.LIMIT[1]+" OFFSET "+r.LIMIT[0]);var m="";return 0!==i.length&&(o||(m=" WHERE "),m+=i.join(n||u)),[m+O,a]},t.createTable=function(r,n,o,i){for(var a=Object.keys(n),s=0;s<a.length;s++)"$"===a[s][0]&&(a[s]=a[s].slice(1)),n[a[s]].constructor===Array?a[s]=e(a[s])+" "+n[a[s]].join(" ").toUpperCase():a[s]=e(a[s])+" "+String(n[a[s]]).toUpperCase();var u="CREATE TABLE IF NOT EXISTS "+e(r)+" ("+a.join(", ")+")";t.SQLQuery(u,[],o,i)},t.select=function(r,n,o,i,a){var s=n;if("*"!==n){n.constructor===String&&(s=[n]);for(var c=0;c<s.length;c++)s[c]=e(s[c])}else s=!1;var l=t.makeWhere(o),f="SELECT "+(s?s.join(", "):n)+" FROM "+e(r)+l[0];t.SQLQuery(f,l[1],function(e){if(0!==e.length&&u(r,"get",e[0]))for(var n=1;n<e.length;n++)u(r,"get",e[n]);i(e)},a)},t.has=function(r,n,o,i){n.LIMIT=1;var a=t.makeWhere(n),s="SELECT 1 FROM "+e(r)+a[0];t.SQLQuery(s,a[1],function(e){if(0!==e.length)return o(!0);o(!1)},i)},t.get=function(e,r,n,o,i){n.LIMIT=1,t.select(e,r,n,function(e){0===e.length?o(null):r.constructor===Array?o(e[0]):o(e[0][r])},i)},t.delete=function(r,n,o,i){if(n){var a=t.makeWhere(n),s="DELETE FROM "+e(r)+a[0];t.SQLQuery(s,a[1],o,i)}else s="TRUNCATE TABLE "+e(r),t.SQLQuery(s,[],o,function(e){-1!==e.indexOf("syntax error")&&t.delete(r,[],o,i)})},t.insert=function(r,n,o,i){var a=[],s=[],c=[],l=JSON.parse(JSON.stringify(n)),f=Object.keys(l);u(r,"set",l);for(var d=0;d<f.length;d++)a.push(e(f[d])),s.push("?"),c.push(l[f[d]]);var v="INSERT INTO "+e(r)+" ("+a.join(", ")+") VALUES ("+s.join(", ")+")";t.SQLQuery(v,c,o,i)},t.update=function(r,n,o,i,a){var s=t.makeWhere(o),c=[],l=[],f=JSON.parse(JSON.stringify(n)),d=Object.keys(f);u(r,"set",f);for(var v=0;v<d.length;v++)c.push(e(d[v])+" = ?"),l.push(f[d[v]]);var p="UPDATE "+e(r)+" SET "+c.join(", ")+s[0];t.SQLQuery(p,l.concat(s[1]),i,a)},t.drop=function(r,n,o){t.SQLQuery("DROP TABLE "+e(r),[],n,o)},t.closeDatabase=function(){t.polyfill||t.db.close(function(){},function(e){var r="Error closing Database:"+e.message;errorCallback?errorCallback(r):console.error(r)})}}(),t.SQLQuery=function(e,n,o,i){r.debug&&r.debug(e,n),t.db.transaction(function(r){r.executeSql(e,n,function(r,t){if(s(n),n=e=null,o){var i=t&&t.rows?t.rows:t;if(t&&t.rowsAffected&&!i.length)return o(t.rowsAffected),void(i=null);if(i.length){for(var a={length:i.length},u=0;u<i.length;u++)a[u]=i[u];i=null,o(a)}else o([])}},function(r,t){var o="Database Error: "+t.message;s(n),n=e=null,i?i(o):console.error(o)})},function(e){var r="Database Transaction Error: "+e.message;i?i(r):console.error(r)})},function r(o){!o&&window.sqlitePlugin?t.db=window.sqlitePlugin.openDatabase({name:e,location:"default"},f,function(){console.error_("Failed to initialize sqlitePlugin"),setTimeout(function(){r(!0)},500)}):window.openDatabase?(t.db=window.openDatabase(e,"1.0",e,1024),t.db&&setTimeout(f,500)):(console.error("WebSQL is not supported on this browser"),n&&n())}()}c||void 0!==r.websql||(r.websql=!0),r.websql&&p(function(){console.warn("Fallback to IndexedDB"),v()})}"undefined"!=typeof process&&process.execPath&&(module.exports=SFDatabase);
//# sourceMappingURL=SFDatabase.min.js.map
