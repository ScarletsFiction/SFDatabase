/*
  SFDatabase-js
  SFDatabase-js is a database library that can help you
  build a SQL Query and execute it to the server from
  Nodejs or local browser with WebSQL.

  https://github.com/ScarletsFiction/SFDatabase-js
*/
"use strict";function SFDatabase(e,n,t){var r=this;r.db=null,r.pending=[],r.initialized=!1,n||(n={debug:!1});var o=function(){r.initialized||(r.initialized=!0,t?setTimeout(function(){t(i)||i()},1):i())},a=-1,i=function e(){if(!r.db)return clearTimeout(a),void(a=setTimeout(e,1e3));if(r.pending.length){for(var n=0;n<r.pending.length;n++)r.pending[n]();r.pending.splice(0)}},s=function(e){if(e&&"object"==typeof e){if(e instanceof Array)e.splice(0);else for(var n=Object.keys(e),t=0;t<n.length;t++)delete e[n[t]];e=null}};r.preprocessTable={};var c=function(e,n,t){var o=!1;if(!r.preprocessTable[e])return o;for(var a=Object.keys(r.preprocessTable[e]),i=0;i<a.length;i++)t[a[i]]&&r.preprocessTable[e][a[i]][n]&&(t[a[i]]=r.preprocessTable[e][a[i]][n](t[a[i]]),o=!0);return o},l="undefined"!=typeof process&&process.execPath;if(!l)var u=null,d=function(){var e=Object.keys(n.databaseStructure),t=e.length,a=function(){0===--t&&o(r)};setTimeout(function(){t>1&&console.error("Failed to initialize database structure")},5e3);for(var i=0;i<e.length;i++)r.createTable(e[i],n.databaseStructure[e[i]],a);u&&(u(),u=null)};function f(){function e(e){return"`"+e.match(/[a-zA-Z0-9_\.]+/i)[0]+"`"}r.makeWhere=function(n,t,o){if(!n)return["",[]];for(var a=[],i=[],s=Object.keys(n),c=" AND ",l=["order","limit"],u=0;u<s.length;u++){var d=n[s[u]],f=s[u].match(/([a-zA-Z0-9_\.]+)(\[(\>\=?|\<\=?|\!|\<\>|\>\<|\!?~)\])?/),b=f[1].toLowerCase();if("and"!==b&&"or"!==b)if(o||-1===l.indexOf(b))if(f[3]){if(-1!==[">",">=","<","<="].indexOf(f[3])){if(!isNaN(d)){a.push(f[1]+" "+f[3]+" ?"),i.push(d);continue}var h="SQL where: value of "+f[1]+" is non-numeric and can't be accepted";console.error(h)}else if("!"===f[3]){var p;if(p=null!=d&&d.constructor.name)if("Array"===p){for(var g=[],v=0;v<d.length;v++)g.push("?");a.push(f[1]+" NOT IN ("+g.join(", ")+")"),i=i.concat(d)}else"Number"===p||"Boolean"===p||"String"===p?(a.push(f[1]+" != ?"),i.push(d)):console.error("SQL where: value "+f[1]+" with type "+p+" can't be accepted");else a.push(f[1]+" IS NOT NULL")}else if("~"===f[3]||"!~"===f[3]){d.constructor!==Array&&(d=[d]);var w=[];for(v=0;v<d.length;v++)w.push(f[1]+("!~"===f[3]?" NOT":"")+" LIKE ?"),-1===d.indexOf("%")&&(d[v]="%"+d[v]+"%"),i.push(d[v]);a.push("("+w.join(" OR ")+")")}}else if(p=null!=d&&d.constructor.name)if("Array"===p){for(g=[],v=0;v<d.length;v++)g.push("?");a.push(f[1]+" IN ("+g.join(", ")+")"),i=i.concat(d)}else"Number"===p||"Boolean"===p||"String"===p?(a.push(f[1]+" = ?"),i.push(d)):console.error("SQL where: value "+f[1]+" with type "+p+" can't be accepted");else a.push(f[1]+" IS NULL")}for(u=0;u<s.length;u++)if("ORDER"!==s[u]&&"LIMIT"!==s[u]){var T=s[u].split("AND"),I=!1;if(2===T.length&&""===T[0]?(c=" AND ",I=!0):2===(T=s[u].split("OR")).length&&""===T[0]&&(c=" OR ",I=!0),I){var y=r.makeWhere(n[s[u]],c,!0);a.push("("+y[0]+")"),i=i.concat(y[1])}}var O="";if(n.ORDER){s=Object.keys(n.ORDER);var m=[];for(u=0;u<s.length;u++){var D=n.ORDER[s[u]].toUpperCase();"ASC"!==D&&"DESC"!==D||m.push(e(s[u])+" "+D)}O=O+" ORDER BY "+m.join(", ")}n.LIMIT&&(isNaN(n.LIMIT[0])||isNaN(n.LIMIT[1])?isNaN(n.LIMIT)||(O=O+" LIMIT "+n.LIMIT):O=O+" LIMIT "+n.LIMIT[1]+" OFFSET "+n.LIMIT[0]);var S="";return 0!==a.length&&(o||(S=" WHERE "),S+=a.join(t||c)),[S+O,i]},r.createTable=function(n,t,o,a){for(var i=Object.keys(t),s=0;s<i.length;s++)"Array"===t[i[s]].constructor.name?i[s]=e(i[s])+" "+t[i[s]][0].toUpperCase()+" "+e(t[i[s]][1]):i[s]=e(i[s])+" "+String(t[i[s]]).toUpperCase();var c="CREATE TABLE IF NOT EXISTS "+e(n)+" ("+i.join(", ")+")";r.SQLQuery(c,[],o,a)},r.select=function(n,t,o,a,i){var s=t;if("*"!==t)for(var l=0;l<s.length;l++)s[l]=e(s[l]);else s=!1;var u=r.makeWhere(o),d="SELECT "+(s?s.join(", "):t)+" FROM "+e(n)+u[0];r.SQLQuery(d,u[1],function(e){if(a){if(0!==e.length&&c(n,"get",e[0]))for(var t=1;t<e.length;t++)c(n,"get",e[t]);a(e)}},i)},r.delete=function(n,t,o,a){if(t){var i=r.makeWhere(t),s="DELETE FROM "+e(n)+i[0];r.SQLQuery(s,i[1],o,a)}else{s="TRUNCATE TABLE "+e(n);r.SQLQuery(s,[],o,function(e){-1!==e.indexOf("syntax error")&&r.delete(n,[],o,a)})}},r.insert=function(n,t,o,a){var i=[],s=[],l=[],u=JSON.parse(JSON.stringify(t)),d=Object.keys(u);c(n,"set",u);for(var f=0;f<d.length;f++)i.push(e(d[f])),s.push("?"),l.push(u[d[f]]);var b="INSERT INTO "+e(n)+" ("+i.join(", ")+") VALUES ("+s.join(", ")+")";r.SQLQuery(b,l,o,a)},r.update=function(n,t,o,a,i){var s=r.makeWhere(o),l=[],u=[],d=JSON.parse(JSON.stringify(t)),f=Object.keys(d);c(n,"set",d);for(var b=0;b<f.length;b++)l.push(e(f[b])+" = ?"),u.push(d[f[b]]);var h="UPDATE "+e(n)+" SET "+l.join(", ")+s[0];r.SQLQuery(h,u.concat(s[1]),a,i)},r.drop=function(n,t,o){r.SQLQuery("DROP TABLE "+e(n),[],t,o)},r.closeDatabase=function(){r.polyfill||r.db.close(function(){},function(e){var n="Error closing Database:"+e.message;errorCallback?errorCallback(n):console.error(n)})}}function b(n){var t,o,a;t=function e(n,t,r){for(var o=!r,i=Object.keys(t),s=0;s<i.length;s++){var c=i[s].match(/([a-zA-Z0-9_\.]+)(\[(\>\=?|\<\=?|\!|\<\>|\>\<|\!?~)\])?/),l=c[1].toLowerCase();if("AND"!==l&&"OR"!==l){var u=!0;if("AND"===c[1])u=e(n,t[i[s]],!1);else if("OR"===c[1])u=e(n,t[i[s]],!0);else if(void 0===c[3])n[c[1]]!=t[i[s]]&&(u=!1);else if("!"===c[3])n[c[1]]==t[i[s]]&&(u=!1);else if(">"===c[3])n[c[1]]<=t[i[s]]&&(u=!1);else if(">="===c[3])n[c[1]]<t[i[s]]&&(u=!1);else if("<"===c[3])n[c[1]]>=t[i[s]]&&(u=!1);else if("<="===c[3])n[c[1]]>t[i[s]]&&(u=!1);else if("><"===c[3])(n[c[1]]<=t[i[s]][0]||n[c[1]]>=t[i[s]][1])&&(u=!1);else if("=><="===c[3])(n[c[1]]<t[i[s]][0]||n[c[1]]>t[i[s]][1])&&(u=!1);else if("<>"===c[3])(n[c[1]]>=t[i[s]][0]||n[c[1]]<=t[i[s]][1])&&(u=!1);else if("<=>"===c[3])(n[c[1]]>t[i[s]][0]||n[c[1]]<t[i[s]][1])&&(u=!1);else if(-1!==c[3].indexOf("~")){var d=1,f=t[i[s]];"%"===t[i[s]].slice(0,1)&&"%"===t[i[s]].slice(-1)?(d=1,f=f.slice(1,-1)):"%"===t[i[s]].slice(0,1)?(d=2,f=f.slice(1)):"%"===t[i[s]].slice(-1)&&(d=3,f=f.slice(0,-1)),f=f.replace(a,"\\$&"),2===d?f="^"+f:3===d&&(f+="$"),f=RegExp(f,"i"),-1!=c[3].indexOf("!")?n[c[1]].match(f)||(u=!1):n[c[1]].match(f)&&(u=!1)}if(r)o=o||u;else if(!u){o=!1;break}}}return o},o=function(e,n,r){if(r)return!(!n.ORDER&&!n.LIMIT);for(var o=Object.keys(n),a=0;a<o.length;a++)if("ORDER"==o[a]){var i=Object.keys(n.ORDER);for(a=0;a<i.length;a++)e.data.sort(sorterByKey(i[a],"DESC"==n.ORDER[i[a]]))}else"LIMIT"==o[a]&&("number"==typeof n.LIMIT?e.data=e.data.splice(0,n.LIMIT):e.data=e.data.splice(n.LIMIT[0],n.LIMIT[1]));if(delete n.LIMIT,delete n.ORDER,0!=Object.keys(n).length)for(a=e.data.length-1;a>=0;a--)t(e.data[a],n)||e.data.splice(a,1)},a=/[-\/\\^$*+?.()|[\]{}]/g,r.createTable=function(e,n,t,o){if(r.db.objectStoreNames.contains(e))return t(r);var a,i=Object.keys(n);try{for(var s=r.db.createObjectStore(e,{keyPath:"rowid",autoIncrement:!0}),c=0;c<i.length;c++){var l="string"!=typeof(a=i[c])?a:a.match(/[a-zA-Z0-9_\.]+/)[0]||"";n[i[c]]instanceof Array&&n[i[c]].length>=2?s.createIndex(l,l,{unique:"unique"===n[i[c]][1]}):s.createIndex(l,l,{unique:!1})}t&&t(r)}catch(e){o&&o(e)}},r.insert=function(e,n,t,o){var a=!1,i=r.getObjectStore(e,"readwrite",function(){!a&&o&&o("table not found")}).add(n);o&&(i.onerror=function(){a=!0,o("duplicate on unique columns")}),t&&(i.onsuccess=function(e){t(e.target.result)})},r.select=function(e,n,a,i,s){var c=r.getObjectStore(e,"readonly",s).openCursor(),l=o(null,a,!0),u=[],d={data:[]},f=function(e){for(var t={},r=0;r<n.length;r++)t[n[r]]=e[n[r]];u.push(t)};c.onerror=s,c.onsuccess=function(e){var n=e.target.result;if(n){var r=n.value;l?d.data.push(r):t(r,a)&&f(r),n.continue()}else{if(l){o(d,a,!1);for(var s=0;s<d.data.length;s++)f(d.data[s])}i(u)}}},r.delete=function(e,n,a,i){var s=r.getObjectStore(e,"readwrite",i),c=s.openCursor(),l=0,u=o(null,n,!0),d={data:[]};c.onerror=i,c.onsuccess=function(e){var r=e.target.result;if(r){var i=r.value;u?d.data.push(i):t(i,n)&&(l++,r.delete()),r.continue()}else if(u){o(d,n,!1);for(var c=0;c<d.data.length;c++)s.delete(d.data[c][s.keyPath]);a&&a(d.data.length)}else a&&a(l)}},r.update=function(e,n,a,i,s){var c=Object.keys(n),l=r.getObjectStore(e,"readwrite",s),u=l.openCursor(),d=0,f=o(null,a,!0),b={data:[]};u.onerror=s;var h=function(e){for(var t=0;t<c.length;t++)e[c[t]]=n[c[t]];d++};u.onsuccess=function(e){var n=e.target.result;if(n){var r=n.value;f?b.data.push(r):t(r,a)&&(h(r),n.update(r)),n.continue()}else{if(f){o(b,a,!1);for(var s=0;s<b.data.length;s++)h(b.data[s]),l.put(b.data[s])}i&&i(d)}}},r.drop=function(e,n,t){r.closeDatabase(),u=function(){try{r.db.deleteObjectStore(e)}catch(e){}},r.initializeTable(n,t)},r.closeDatabase=function(){r.db.close()},window.indexedDB||(window.indexedDB=window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB),window.IDBTransaction||(window.IDBTransaction=window.webkitIDBTransaction||window.msIDBTransaction),window.IDBKeyRange||(window.IDBKeyRange=window.webkitIDBKeyRange||window.msIDBKeyRange),window.indexedDB&&window.IDBTransaction&&window.IDBKeyRange?(r.storage="indexeddb",r.db=window.indexedDB.open(e,1),r.db.onerror=n,r.db.onupgradeneeded=r.db.versionchange=function(e){r.db.result&&(r.db=r.db.result)},r.db.onsuccess=function(e){r.db.result&&(r.db=r.db.result),d()},r.getObjectStore=function(e,n,t){var o=r.db.transaction(e,n);return o.onerror=t,o.objectStore(e)}):n()}function h(e){f();var t;r.SQLQuery=function(e,t,o,c){if(!r.initialized)return r.pending.push(function(){r.SQLQuery(e,t,o,c)}),clearTimeout(a),void(a=setTimeout(i,1e3));n.debug&&n.debug(e,t),r.db.transaction(function(n){n.executeSql(e,t,function(n,r){if(s(t),t=e=null,o){var a=r&&r.rows?r.rows:r;if(r&&r.rowsAffected&&!a.length)return o(r.rowsAffected),void(a=null);if(a.length){for(var i={length:a.length},c=0;c<a.length;c++)i[c]=a[c];a=null,o(i)}else o([])}},function(n,r){var o="Database Error: "+r.message;s(t),t=e=null,c?c(o):console.error(o)})},function(e){var n="Database Transaction Error: "+e.message;c?c(n):console.error(n)})},!t&&window.sqlitePlugin?r.db=window.sqlitePlugin.openDatabase({name:r.databaseName,location:"default"},d,function(){console.error_("Failed to initialize sqlitePlugin"),setTimeout(function(){r.initializeTable(!0)},500)}):window.openDatabase?(r.db=window.openDatabase(r.databaseName,"1.0",r.databaseName,1024),r.db&&setTimeout(d,500)):(console.error("WebSQL is not supported on this browser"),e&&e())}l||n.websql||b(function(){h()}),l&&void 0===n.mysql&&(n.mysql=!0),n.mysql&&function(c){f();var l=require("mysql");r.db=l.createPool({host:n.host?n.host:"localhost",user:n.user?n.user:"root",password:n.password?n.password:"",database:e}),t&&r.db.on("connection",o);n.hideInitialization||console.log("Connecting to "+e+" database");r.SQLQuery=function(e,t,o,c){if(!r.initialized)return r.pending.push(function(){r.SQLQuery(e,t,o,c)}),clearTimeout(a),void(a=setTimeout(i,1e3));n.debug&&n.debug(e,t),r.db.getConnection(function(n,r){if(n)return r.release(),void(c?c(n):console.error(n));r.query(e,t,function(n,a){r.release(),s(t),t=null,e=null,!n&&o?setTimeout(function(){o(a)},0):n&&setTimeout(function(){var e={msg:n.sqlMessage,query:n.sql,code:n.code};c?c(e):console.error(e)},0)})})}}(),l||void 0!==n.websql||(n.websql=!0),n.websql&&h(function(){b()})}
//# sourceMappingURL=sfdatabase.min.js.map
